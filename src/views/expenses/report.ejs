<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title" style="font-size: 1.5rem; text-transform: capitalize;">Expenses Report</h1>
  </div>
  <div style="display: flex; align-items: center; gap: 1rem; margin-top: 0.5rem; flex-wrap: wrap;">
    <label for="yearFilter" style="font-weight: 500; color: hsl(210, 6%, 21%);">Year:</label>
    <select id="yearFilter" style="padding: 0.5rem 1rem; border: 1px solid hsl(210, 11%, 85%); border-radius: 0.375rem; font-size: 0.875rem; background-color: white; cursor: pointer;">
      <option value="current">Current Year</option>
      <option value="all">All Years</option>
    </select>
    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500; color: hsl(210, 6%, 21%); cursor: pointer;">
      <input type="checkbox" id="showSubcategories" style="width: 1rem; height: 1rem; cursor: pointer;">
      View all subcategories
    </label>
    <button id="exportExcelBtn" class="btn btn-primary" style="display: none; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; white-space: nowrap;">
      <i class="bi bi-file-earmark-spreadsheet"></i>
      Export to Excel
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="loading-container">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="loading-text">Loading expenses report data...</p>
</div>

<!-- Content Container -->
<div id="content-container" class="content-container" style="display: none;">
  <!-- Expenses Report Table -->
  <div class="table-container">
    <div class="table-card">
      <div class="table-header">
        <div class="table-title">
        </div>
      </div>
      
      <div class="table-wrapper">
        <table class="expenses-report-table" id="expensesReportTable">
          <thead class="sticky-header" id="expensesReportTableHead">
            <!-- Header will be generated dynamically -->
          </thead>
          <tbody id="expensesReportTableBody">
            <!-- Data will be loaded via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Expense Details Modal -->
<div id="expenseDetailsModal" class="modal-overlay">
  <div class="modal-container" style="max-width: 1200px;">
    <div class="modal-header">
      <h3 id="modalTitle">Expense Details</h3>
      <button class="modal-close" id="closeDetailsModalBtn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div id="expenseDetailsContent">
        <!-- Details will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>

<script>
// Currency conversion rates
// AED_TO_USD: 3.6735 means 1 USD = 3.6735 AED, so 1 AED = 1/3.6735 USD ≈ 0.2722 USD
// AED_TO_EUR: 4.3119 means 1 EUR = 4.3119 AED, so 1 AED = 1/4.3119 EUR ≈ 0.2319 EUR
// EUR conversions always go through AED (not directly to USD)
const CURRENCY_RATES = {
  AED_TO_USD: 3.6735, // 1 USD = 3.6735 AED
  AED_TO_EUR: 4.3119, // 1 EUR = 4.3119 AED
};

// Expense categories
const NON_FLIGHT_CATEGORIES = [
  'CAMO and Management',
  'Crew',
  'Disbursement fee',
  'Insurance charge',
  'Maintenance',
  'Subscriptions',
  'Other charges', // non-flights subtype
  'FalconCare',
  'Honeywell'
];

const FLIGHT_CATEGORIES = [
  'Ground handling',
  'Fuel',
  'Navigation charges',
  'Overfly charges',
  'Catering',
  'Flight planning',
  'Other charges' // flights subtype
];

// Convert amount to target currency
// EUR conversions always go through AED (not directly to USD)
function convertCurrency(amount, fromCurrency, toCurrency) {
  if (!amount || !fromCurrency || !toCurrency) return 0;
  if (fromCurrency === toCurrency) return amount;

  // Handle EUR conversions - always through AED
  if (fromCurrency === 'EUR') {
    // EUR → AED: 1 EUR = 4.3119 AED
    const amountInAED = amount * CURRENCY_RATES.AED_TO_EUR;
    
    if (toCurrency === 'AED') {
      return amountInAED;
    } else if (toCurrency === 'USD') {
      // EUR → AED → USD: 1 AED = 1/3.6735 USD
      return amountInAED / CURRENCY_RATES.AED_TO_USD;
    }
  }
  
  if (toCurrency === 'EUR') {
    // Convert to AED first, then to EUR
    let amountInAED = 0;
    if (fromCurrency === 'USD') {
      // USD → AED: 1 USD = 3.6735 AED
      amountInAED = amount * CURRENCY_RATES.AED_TO_USD;
    } else if (fromCurrency === 'AED') {
      amountInAED = amount;
    }
    // AED → EUR: 1 AED = 1/4.3119 EUR
    return amountInAED / CURRENCY_RATES.AED_TO_EUR;
  }

  // For non-EUR conversions, convert through USD
  // Convert to USD first
  let amountInUSD = amount;
  if (fromCurrency === 'AED') {
    // 1 AED = 1/3.6735 USD
    amountInUSD = amount / CURRENCY_RATES.AED_TO_USD;
  }

  // Convert from USD to target
  if (toCurrency === 'USD') {
    return amountInUSD;
  } else if (toCurrency === 'AED') {
    // 1 USD = 3.6735 AED
    return amountInUSD * CURRENCY_RATES.AED_TO_USD;
  }

  return amount;
}

// Get base expense category (without subtype) - for table display
function getBaseExpenseCategory(expense) {
  const type = (expense.exp_type || '').toLowerCase();

  // Check for non-flight categories
  if (type === 'camo and management' || (type.includes('camo') && type.includes('management'))) {
    return 'CAMO and Management';
  }
  if (type === 'crew') {
    return 'Crew';
  }
  if (type === 'disbursement fee' || type.includes('disbursement')) {
    return 'Disbursement fee';
  }
  if (type === 'insurance charge' || type.includes('insurance')) {
    return 'Insurance charge';
  }
  if (type === 'maintenance') {
    return 'Maintenance';
  }
  if (type === 'subscriptions' || type.includes('subscription')) {
    return 'Subscriptions';
  }
  if (type === 'falconcare' || type.includes('falconcare') || type.includes('falcon care')) {
    return 'FalconCare';
  }
  if (type === 'honeywell') {
    return 'Honeywell';
  }
  
  // Check for flight categories
  if (type === 'ground handling' || type.includes('ground handling') || type.includes('groundhandling')) {
    return 'Ground handling';
  }
  if (type === 'fuel') {
    return 'Fuel';
  }
  if (type === 'navigation charges' || type.includes('navigation') || type.includes('enroute')) {
    return 'Navigation charges';
  }
  if (type === 'overfly charges' || type.includes('overfly') || type.includes('overflight')) {
    return 'Overfly charges';
  }
  if (type === 'catering' || type.includes('catering') || type.includes('food')) {
    return 'Catering';
  }
  if (type === 'flight planning' || type.includes('flight planning') || type.includes('flightplanning')) {
    return 'Flight planning';
  }
  
  // Check for Other charges - determine by flight association
  if (type === 'other charges' || type.includes('other charges')) {
    return 'Other charges';
  }

  // Return null if not in any category
  return null;
}

// Get expense category with subtype - for modal display
function getExpenseCategory(expense) {
  const type = (expense.exp_type || '').toLowerCase();
  const subtype = (expense.exp_subtype || '').trim();
  const baseCategory = getBaseExpenseCategory(expense);
  
  if (baseCategory === null) {
    return null;
  }
  
  return subtype ? `${baseCategory} - ${subtype}` : baseCategory;
}

// Check if expense is non-flight related
function isNonFlightExpense(expense) {
  const baseCategory = getBaseExpenseCategory(expense);
  
  // If category is null, expense doesn't belong to any group - skip it
  if (baseCategory === null) {
    return null;
  }
  
  // Check if base category is in non-flight list
  return NON_FLIGHT_CATEGORIES.includes(baseCategory);
}

// Split expense by months - uses period or flight date
function splitExpenseByMonths(expense) {
  const amount = parseFloat(expense.exp_amount) || 0;
  const currency = expense.exp_currency || 'USD';
  const periodStart = expense.exp_period_start;
  const periodEnd = expense.exp_period_end;
  const flightId = expense.exp_flight;

  // If expense has a flight, use flight date
  if (flightId && expense.flights && expense.flights.flt_date) {
    const flightDate = new Date(expense.flights.flt_date);
    const monthKey = `${flightDate.getFullYear()}-${String(flightDate.getMonth() + 1).padStart(2, '0')}`;
    return [{ monthKey, amount, currency, expense }];
  }

  // If expense has a period, split by months
  // User always enters only month and year (YYYY-MM format), system converts to dates
  // If start and end are the same month, system sets end as 1st day of next month
  if (periodStart && periodEnd) {
    const start = new Date(periodStart);
    const end = new Date(periodEnd);
    const months = [];

    // Calculate number of months covered
    const startYear = start.getFullYear();
    const startMonth = start.getMonth();
    const endYear = end.getFullYear();
    const endMonth = end.getMonth();
    const endDay = end.getDate();

    // Check if end date is the first day of the next month (indicating single month period)
    // This happens when user enters the same month for start and end (e.g., both "2024-01")
    // System automatically sets end as 1st day of next month (e.g., "2024-02-01")
    const isSingleMonth = (
      endDay === 1 && 
      ((endMonth === (startMonth + 1) % 12 && endYear === startYear) ||
       (endMonth === 0 && endYear === startYear + 1))
    );

    // Calculate total number of months (inclusive)
    // If it's a single month period (end is 1st of next month), count as 1 month
    let totalMonths;
    if (isSingleMonth) {
      // Single month period - entire amount goes to start month
      totalMonths = 1;
    } else {
      // Multiple months period - calculate difference
      // Formula: (endYear - startYear) * 12 + (endMonth - startMonth) + 1
      // The +1 is because we count both start and end months inclusively
      // Example: Jan (0) to Mar (2) = (0-0)*12 + (2-0) + 1 = 3 months
      totalMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
    }
    
    // Divide the total amount by the number of months to get monthly portion
    // Each month gets an equal share of the total expense
    const monthlyAmount = totalMonths > 0 ? amount / totalMonths : amount;

    // Generate month keys for all months in the period
    let currentYear = startYear;
    let currentMonth = startMonth;

    for (let i = 0; i < totalMonths; i++) {
      const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
      months.push({ monthKey, amount: monthlyAmount, currency, expense });

      currentMonth++;
      if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
      }
    }

    return months.length > 0 ? months : [{ monthKey: `${startYear}-${String(startMonth + 1).padStart(2, '0')}`, amount, currency, expense }];
  }

  // If no period and no flight, use creation date
  const date = expense.created_at ? new Date(expense.created_at) : new Date();
  const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
  return [{ monthKey, amount, currency, expense }];
}

// Global variables for filtering
let allExpensesData = null;
let allCategoryGroups = null;
let expenseDetailsMap = {}; // Map to store expense details: { category_monthKey: [expenses] }
let showSubcategories = false; // Flag to show subcategories

// Load and process expenses
async function loadExpensesReport() {
  try {
    const response = await apiRequest('/api/expenses');
    const expenses = await response.json();

    if (!Array.isArray(expenses)) {
      throw new Error('Invalid expenses data format');
    }

    // Store all expenses
    allExpensesData = expenses;

    // Process expenses (now async)
    await processExpensesData(expenses);

    // Hide loading spinner and show content
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('content-container').style.display = 'block';
    
    // Show export button
    const exportBtn = document.getElementById('exportExcelBtn');
    if (exportBtn) {
      exportBtn.style.display = 'inline-flex';
    }
    
    // Update table header position after content is shown
    setTimeout(updateTableHeaderPosition, 100);
  } catch (error) {
    console.error('Error loading expenses report:', error);
    document.getElementById('loading-spinner').innerHTML = `
      <div style="text-align: center; padding: 2rem; color: #6b7280;">
        <i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
        Failed to load expenses report. Please try again.
        <br><small>Error: ${error.message}</small>
      </div>
    `;
  }
}

// Process expenses data
async function processExpensesData(expenses) {
  // Reset expense details map
  expenseDetailsMap = {};
  
  // Process expenses - filter only those in specified groups
  const expensesByMonth = {};
  const categoryGroups = {
    nonFlight: {},
    flight: {}
  };
  
  // Income items (Credit note and Charter profit)
  const incomeItems = {
    creditNote: {},
    charterProfit: {}
  };
  
  // Process expenses - separate income items from regular expenses using exp_category
  for (const expense of expenses) {
    // Check if this is an income item using exp_category field
    const expCategory = expense.exp_category || 'expense';
    
    if (expCategory === 'income_credit_note' || expCategory === 'income_charter_profit') {
      // Process as income item
      const incomeType = expCategory === 'income_credit_note' ? 'creditNote' : 'charterProfit';
      const months = splitExpenseByMonths(expense);
      
        // Log income items for debugging
        const monthKeys = months.map(m => m.monthKey);
        console.log(`[Income] ${incomeType}:`, JSON.stringify({
          invoice: expense.invoices?.inv_number,
          category: expCategory,
          amount: expense.exp_amount,
          currency: expense.exp_currency,
          period: expense.exp_period_start ? `${expense.exp_period_start} - ${expense.exp_period_end}` : expense.flights?.flt_date || 'N/A',
          months: monthKeys
        }, null, 2));
      
      for (const { monthKey, amount, currency } of months) {
        if (!expensesByMonth[monthKey]) {
          expensesByMonth[monthKey] = {};
        }
        
        if (!incomeItems[incomeType][monthKey]) {
          incomeItems[incomeType][monthKey] = { USD: 0, AED: 0 };
        }
        
        // Store expense details
        const detailKey = `${incomeType}_${monthKey}`;
        if (!expenseDetailsMap[detailKey]) {
          expenseDetailsMap[detailKey] = [];
        }
        const totalMonths = months.length || 1;
        const originalTotalAmount = parseFloat(expense.exp_amount) || 0;
        const monthlyAmount = totalMonths > 0 ? originalTotalAmount / totalMonths : originalTotalAmount;
        
        expenseDetailsMap[detailKey].push({
          expense: expense,
          amount: originalTotalAmount,
          currency: currency,
          monthlyAmount: monthlyAmount,
          totalMonths: totalMonths
        });
        
        // Add amount in original currency and convert to fill both columns
        if (currency === 'USD') {
          incomeItems[incomeType][monthKey].USD += amount;
          const aedAmount = convertCurrency(amount, 'USD', 'AED');
          incomeItems[incomeType][monthKey].AED += aedAmount;
        } else if (currency === 'AED') {
          incomeItems[incomeType][monthKey].AED += amount;
          const usdAmount = convertCurrency(amount, 'AED', 'USD');
          incomeItems[incomeType][monthKey].USD += usdAmount;
        } else if (currency === 'EUR') {
          const usdAmount = convertCurrency(amount, 'EUR', 'USD');
          const aedAmount = convertCurrency(amount, 'EUR', 'AED');
          incomeItems[incomeType][monthKey].USD += usdAmount;
          incomeItems[incomeType][monthKey].AED += aedAmount;
        } else {
          const usdAmount = convertCurrency(amount, currency, 'USD');
          const aedAmount = convertCurrency(amount, currency, 'AED');
          incomeItems[incomeType][monthKey].USD += usdAmount;
          incomeItems[incomeType][monthKey].AED += aedAmount;
        }
      }
      continue; // Skip regular expense processing for income items
    }
    
    const baseCategory = getBaseExpenseCategory(expense);
    
    // Skip expenses that don't belong to any category
    if (baseCategory === null) {
      continue;
    }

    // Determine which category to use based on showSubcategories flag
    const displayCategory = showSubcategories ? getExpenseCategory(expense) : baseCategory;
    
    // If getExpenseCategory returned null, use baseCategory
    const finalCategory = displayCategory || baseCategory;

    const isNonFlight = isNonFlightExpense(expense);
    const group = isNonFlight ? categoryGroups.nonFlight : categoryGroups.flight;

    if (!group[finalCategory]) {
      group[finalCategory] = {};
    }

    const months = splitExpenseByMonths(expense);

    for (const { monthKey, amount, currency } of months) {
      if (!expensesByMonth[monthKey]) {
        expensesByMonth[monthKey] = {};
      }

      if (!group[finalCategory][monthKey]) {
        group[finalCategory][monthKey] = { USD: 0, AED: 0 };
      }

      // Store expense details for this cell (using final category for table)
      const detailKey = `${finalCategory}_${monthKey}`;
      if (!expenseDetailsMap[detailKey]) {
        expenseDetailsMap[detailKey] = [];
      }
      // Calculate monthly amount (already divided in splitExpenseByMonths)
      // The amount here is already the monthly portion for this specific month
      const totalMonths = months.length || 1;
      const originalTotalAmount = parseFloat(expense.exp_amount) || 0;
      // Calculate monthly amount - this is the portion for each month
      const monthlyAmount = totalMonths > 0 ? originalTotalAmount / totalMonths : originalTotalAmount;
      
      expenseDetailsMap[detailKey].push({
        expense: expense,
        amount: originalTotalAmount, // Full amount of the expense
        currency: currency,
        monthlyAmount: monthlyAmount, // Monthly portion for this month
        totalMonths: totalMonths // Total number of months the expense spans
      });
      
      // Add amount in original currency and convert to fill both columns
      if (currency === 'USD') {
        group[finalCategory][monthKey].USD += amount;
        // Convert USD to AED
        const aedAmount = convertCurrency(amount, 'USD', 'AED');
        group[finalCategory][monthKey].AED += aedAmount;
      } else if (currency === 'AED') {
        group[finalCategory][monthKey].AED += amount;
        // Convert AED to USD
        const usdAmount = convertCurrency(amount, 'AED', 'USD');
        group[finalCategory][monthKey].USD += usdAmount;
      } else if (currency === 'EUR') {
        // Convert EUR to USD and AED
        const usdAmount = convertCurrency(amount, 'EUR', 'USD');
        const aedAmount = convertCurrency(amount, 'EUR', 'AED');
        group[finalCategory][monthKey].USD += usdAmount;
        group[finalCategory][monthKey].AED += aedAmount;
      } else {
        // Unknown currency, try to convert to USD and AED
        const usdAmount = convertCurrency(amount, currency, 'USD');
        const aedAmount = convertCurrency(amount, currency, 'AED');
        group[finalCategory][monthKey].USD += usdAmount;
        group[finalCategory][monthKey].AED += aedAmount;
      }
    }
  }

  // Store processed data
  allCategoryGroups = categoryGroups;
  window.incomeItems = incomeItems; // Store income items globally for rendering

  // Get all months from expenses and income items, then filter by year
  const allMonthsSet = new Set(Object.keys(expensesByMonth));
  
  // Add months from income items
  Object.keys(incomeItems.creditNote).forEach(monthKey => allMonthsSet.add(monthKey));
  Object.keys(incomeItems.charterProfit).forEach(monthKey => allMonthsSet.add(monthKey));
  
  const allMonths = Array.from(allMonthsSet).sort();
  const filteredMonths = filterMonthsByYear(allMonths);
  
  // Log income items summary with details
  const creditNoteMonths = Object.keys(incomeItems.creditNote);
  const charterProfitMonths = Object.keys(incomeItems.charterProfit);
  console.log('[Income Summary]', JSON.stringify({
    creditNoteMonths: creditNoteMonths,
    charterProfitMonths: charterProfitMonths,
    creditNoteData: incomeItems.creditNote,
    charterProfitData: incomeItems.charterProfit
  }, null, 2));

  // Render table
  renderExpensesReportTable(categoryGroups, filteredMonths, incomeItems);
}

// Filter months by selected year
function filterMonthsByYear(months) {
  const yearFilter = document.getElementById('yearFilter')?.value || 'current';
  const currentYear = new Date().getFullYear();

  if (yearFilter === 'current') {
    return months.filter(monthKey => {
      const year = parseInt(monthKey.split('-')[0]);
      return year === currentYear;
    });
  } else if (yearFilter === 'all') {
    return months;
  } else {
    // Specific year selected
    const selectedYear = parseInt(yearFilter);
    return months.filter(monthKey => {
      const year = parseInt(monthKey.split('-')[0]);
      return year === selectedYear;
    });
  }
}

// Update year filter options
function updateYearFilterOptions(months) {
  const yearFilter = document.getElementById('yearFilter');
  if (!yearFilter) return;

  // Get all unique years from months
  const years = [...new Set(months.map(monthKey => parseInt(monthKey.split('-')[0])))].sort((a, b) => b - a);
  
  // Clear existing options except first two
  const currentValue = yearFilter.value;
  yearFilter.innerHTML = '<option value="current">Current Year</option><option value="all">All Years</option>';
  
  // Add specific year options
  years.forEach(year => {
    const option = document.createElement('option');
    option.value = year.toString();
    option.textContent = year.toString();
    yearFilter.appendChild(option);
  });

  // Restore previous selection if it still exists
  if (currentValue && Array.from(yearFilter.options).some(opt => opt.value === currentValue)) {
    yearFilter.value = currentValue;
  }
}

// Category groups and sorting order
const CATEGORY_GROUPS = {
  group1: ['CAMO and Management', 'Flight planning', 'Subscriptions', 'Maintenance', 'Insurance charge', 'Crew'],
  group2: ['FalconCare', 'Honeywell'],
  group3: ['Ground handling', 'Fuel', 'Navigation charges', 'Overfly charges', 'Catering', 'Other charges', 'Disbursement fee']
};

// Get group number for a category (1, 2, or 3)
function getCategoryGroup(category) {
  if (CATEGORY_GROUPS.group1.includes(category)) return 1;
  if (CATEGORY_GROUPS.group2.includes(category)) return 2;
  if (CATEGORY_GROUPS.group3.includes(category)) return 3;
  return 0; // Unknown category
}

// Get sort order for a category
function getCategorySortOrder(category) {
  const allCategories = [...CATEGORY_GROUPS.group1, ...CATEGORY_GROUPS.group2, ...CATEGORY_GROUPS.group3];
  const index = allCategories.indexOf(category);
  return index >= 0 ? index : 999; // Unknown categories go to the end
}

// Get pastel background color for a group
function getGroupBackgroundColor(group) {
  switch(group) {
    case 1: return 'hsl(200, 50%, 96%)'; // Light blue pastel
    case 2: return 'hsl(280, 40%, 96%)'; // Light purple pastel
    case 3: return 'hsl(120, 30%, 97%)'; // Light green pastel
    default: return 'white';
  }
}

// Render expenses report table
function renderExpensesReportTable(categoryGroups, months, incomeItems = { creditNote: {}, charterProfit: {} }) {
  
  // Update year filter options
  if (allExpensesData && allCategoryGroups) {
    // Get all months from category groups and income items
    const allMonthsSet = new Set();
    Object.values(allCategoryGroups.nonFlight).forEach(category => {
      Object.keys(category).forEach(monthKey => allMonthsSet.add(monthKey));
    });
    Object.values(allCategoryGroups.flight).forEach(category => {
      Object.keys(category).forEach(monthKey => allMonthsSet.add(monthKey));
    });
    // Add months from income items
    if (incomeItems.creditNote) {
      Object.keys(incomeItems.creditNote).forEach(monthKey => allMonthsSet.add(monthKey));
    }
    if (incomeItems.charterProfit) {
      Object.keys(incomeItems.charterProfit).forEach(monthKey => allMonthsSet.add(monthKey));
    }
    const allMonths = Array.from(allMonthsSet).sort();
    updateYearFilterOptions(allMonths);
  }
  const thead = document.getElementById('expensesReportTableHead');
  const tbody = document.getElementById('expensesReportTableBody');

  // Clear existing content
  thead.innerHTML = '';
  tbody.innerHTML = '';

  // Create header row
  const headerRow = document.createElement('tr');
  const categoryHeader = document.createElement('th');
  categoryHeader.textContent = 'Category';
  categoryHeader.style.minWidth = '220px';
  categoryHeader.style.maxWidth = '350px';
  categoryHeader.style.width = 'auto';
  categoryHeader.rowSpan = 2;
  categoryHeader.style.backgroundColor = 'hsl(210, 11%, 96%)';
  categoryHeader.style.borderRight = '2px solid hsl(210, 11%, 85%)';
  categoryHeader.style.whiteSpace = 'normal';
  headerRow.appendChild(categoryHeader);

  // Add month columns with USD and AED subcolumns
  months.forEach((monthKey, index) => {
    const [year, month] = monthKey.split('-');
    const monthName = new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
    
    const monthHeader = document.createElement('th');
    monthHeader.colSpan = 2;
    monthHeader.textContent = monthName;
    monthHeader.style.textAlign = 'center';
    monthHeader.style.minWidth = '240px';
    monthHeader.style.color = 'hsl(210, 6%, 46%)';
    monthHeader.style.backgroundColor = 'hsl(210, 11%, 96%)';
    // Add border-left for all months except the first
    if (index > 0) {
      monthHeader.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    headerRow.appendChild(monthHeader);
  });

  thead.appendChild(headerRow);

  // Create subheader row for currencies
  const subHeaderRow = document.createElement('tr');
  // Don't add category cell here - it's already in headerRow with rowSpan=2

  months.forEach((monthKey, monthIndex) => {
    const usdHeader = document.createElement('th');
    usdHeader.textContent = 'USD';
    usdHeader.style.textAlign = 'center';
    usdHeader.style.minWidth = '120px';
    usdHeader.style.width = '120px';
    usdHeader.style.backgroundColor = 'hsl(210, 11%, 96%)';
    // Add border-left for all months except the first
    if (monthIndex > 0) {
      usdHeader.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    subHeaderRow.appendChild(usdHeader);

    const aedHeader = document.createElement('th');
    aedHeader.textContent = 'AED';
    aedHeader.style.textAlign = 'center';
    aedHeader.style.minWidth = '120px';
    aedHeader.style.width = '120px';
    aedHeader.style.backgroundColor = 'hsl(210, 11%, 96%)';
    subHeaderRow.appendChild(aedHeader);
  });

  thead.appendChild(subHeaderRow);

  // Combine all categories and sort by custom order
  const allCategories = [];
  
  // Collect all categories from both groups
  Object.keys(categoryGroups.nonFlight).forEach(category => {
    allCategories.push({ category, source: 'nonFlight' });
  });
  Object.keys(categoryGroups.flight).forEach(category => {
    allCategories.push({ category, source: 'flight' });
  });
  
  // Sort by custom order
  // For subcategories, extract base category for sorting
  allCategories.sort((a, b) => {
    // Extract base category (before " - ")
    const baseCategoryA = a.category.split(' - ')[0];
    const baseCategoryB = b.category.split(' - ')[0];
    
    const orderA = getCategorySortOrder(baseCategoryA);
    const orderB = getCategorySortOrder(baseCategoryB);
    
    // If same base category, sort alphabetically by full category name
    if (orderA === orderB) {
      return a.category.localeCompare(b.category);
    }
    
    return orderA - orderB;
  });

  // Render categories in sorted order
  allCategories.forEach(({ category, source }) => {
    const row = document.createElement('tr');
    // Extract base category for color coding (remove " - subtype" part if present)
    const baseCategoryForColor = category.split(' - ')[0];
    const group = getCategoryGroup(baseCategoryForColor);
    const bgColor = getGroupBackgroundColor(group);
    
    const categoryCell = document.createElement('td');
    
    // Display category (with subtype if showSubcategories is enabled)
    categoryCell.textContent = category;
    categoryCell.style.fontWeight = '500';
    
    categoryCell.style.position = 'sticky';
    categoryCell.style.left = '0';
    categoryCell.style.zIndex = '90';
    categoryCell.style.backgroundColor = bgColor;
    categoryCell.style.borderRight = '2px solid hsl(210, 11%, 85%)';
    row.appendChild(categoryCell);

    // Set row background color
    row.style.backgroundColor = bgColor;

    const categoryData = source === 'nonFlight' ? categoryGroups.nonFlight[category] : categoryGroups.flight[category];

    months.forEach((monthKey, monthIndex) => {
      const data = categoryData[monthKey] || { USD: 0, AED: 0 };
      
      const usdCell = document.createElement('td');
      usdCell.textContent = data.USD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      usdCell.style.textAlign = 'right';
      usdCell.style.minWidth = '120px';
      usdCell.style.width = '120px';
      usdCell.style.backgroundColor = bgColor;
      // Add border-left for all months except the first
      if (monthIndex > 0) {
        usdCell.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
      }
      if (data.USD > 0 || data.AED > 0) {
        usdCell.style.cursor = 'pointer';
        usdCell.style.color = 'hsl(210, 76%, 36%)';
        usdCell.title = 'Click to view details';
        usdCell.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showExpenseDetails(category, monthKey, 'USD');
        });
      }
      row.appendChild(usdCell);

      const aedCell = document.createElement('td');
      aedCell.textContent = data.AED.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      aedCell.style.textAlign = 'right';
      aedCell.style.minWidth = '120px';
      aedCell.style.width = '120px';
      aedCell.style.backgroundColor = bgColor;
      if (data.USD > 0 || data.AED > 0) {
        aedCell.style.cursor = 'pointer';
        aedCell.style.color = 'hsl(210, 76%, 36%)';
        aedCell.title = 'Click to view details';
        aedCell.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          showExpenseDetails(category, monthKey, 'AED');
        });
      }
      row.appendChild(aedCell);
    });

    tbody.appendChild(row);
  });

  // Add Credit note row (before Total)
  const creditNoteRow = document.createElement('tr');
  creditNoteRow.style.backgroundColor = 'hsl(210, 11%, 98%)';
  creditNoteRow.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  
  const creditNoteCategoryCell = document.createElement('td');
  creditNoteCategoryCell.textContent = 'Credit note';
  creditNoteCategoryCell.style.fontWeight = '600';
  creditNoteCategoryCell.style.position = 'sticky';
  creditNoteCategoryCell.style.left = '0';
  creditNoteCategoryCell.style.zIndex = '90';
  creditNoteCategoryCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
  creditNoteCategoryCell.style.borderRight = '2px solid hsl(210, 11%, 85%)';
  creditNoteCategoryCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  creditNoteRow.appendChild(creditNoteCategoryCell);

  months.forEach((monthKey, monthIndex) => {
    const data = incomeItems.creditNote[monthKey] || { USD: 0, AED: 0 };
    
    const usdCell = document.createElement('td');
    usdCell.textContent = data.USD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    usdCell.style.textAlign = 'right';
    usdCell.style.fontWeight = '600';
    usdCell.style.minWidth = '120px';
    usdCell.style.width = '120px';
    usdCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    usdCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    if (monthIndex > 0) {
      usdCell.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    creditNoteRow.appendChild(usdCell);

    const aedCell = document.createElement('td');
    aedCell.textContent = data.AED.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    aedCell.style.textAlign = 'right';
    aedCell.style.fontWeight = '600';
    aedCell.style.minWidth = '120px';
    aedCell.style.width = '120px';
    aedCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    aedCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    creditNoteRow.appendChild(aedCell);
  });

  tbody.appendChild(creditNoteRow);

  // Add Total row
  const totalRow = document.createElement('tr');
  totalRow.style.backgroundColor = 'hsl(210, 11%, 98%)';
  totalRow.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  
  const totalCategoryCell = document.createElement('td');
  totalCategoryCell.textContent = 'Total';
  totalCategoryCell.style.fontWeight = '700';
  totalCategoryCell.style.position = 'sticky';
  totalCategoryCell.style.left = '0';
  totalCategoryCell.style.zIndex = '90';
  totalCategoryCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
  totalCategoryCell.style.borderRight = '2px solid hsl(210, 11%, 85%)';
  totalCategoryCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  totalRow.appendChild(totalCategoryCell);

  // Calculate totals for each month
  months.forEach((monthKey, monthIndex) => {
    let totalUSD = 0;
    let totalAED = 0;

    // Sum all categories for this month
    allCategories.forEach(({ category, source }) => {
      const categoryData = source === 'nonFlight' ? categoryGroups.nonFlight[category] : categoryGroups.flight[category];
      const data = categoryData[monthKey] || { USD: 0, AED: 0 };
      totalUSD += data.USD;
      totalAED += data.AED;
    });

    const usdCell = document.createElement('td');
    usdCell.textContent = totalUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    usdCell.style.textAlign = 'right';
    usdCell.style.fontWeight = '700';
    usdCell.style.minWidth = '120px';
    usdCell.style.width = '120px';
    usdCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    usdCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    // Add border-left for all months except the first
    if (monthIndex > 0) {
      usdCell.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    totalRow.appendChild(usdCell);

    const aedCell = document.createElement('td');
    aedCell.textContent = totalAED.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    aedCell.style.textAlign = 'right';
    aedCell.style.fontWeight = '700';
    aedCell.style.minWidth = '120px';
    aedCell.style.width = '120px';
    aedCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    aedCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    totalRow.appendChild(aedCell);
  });

  tbody.appendChild(totalRow);

  // Add Charter profit row (after Total)
  const charterProfitRow = document.createElement('tr');
  charterProfitRow.style.backgroundColor = 'hsl(210, 11%, 98%)';
  charterProfitRow.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  
  const charterProfitCategoryCell = document.createElement('td');
  charterProfitCategoryCell.textContent = 'Charter profit';
  charterProfitCategoryCell.style.fontWeight = '600';
  charterProfitCategoryCell.style.position = 'sticky';
  charterProfitCategoryCell.style.left = '0';
  charterProfitCategoryCell.style.zIndex = '90';
  charterProfitCategoryCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
  charterProfitCategoryCell.style.borderRight = '2px solid hsl(210, 11%, 85%)';
  charterProfitCategoryCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  charterProfitRow.appendChild(charterProfitCategoryCell);

  months.forEach((monthKey, monthIndex) => {
    const data = incomeItems.charterProfit[monthKey] || { USD: 0, AED: 0 };
    
    const usdCell = document.createElement('td');
    usdCell.textContent = data.USD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    usdCell.style.textAlign = 'right';
    usdCell.style.fontWeight = '600';
    usdCell.style.minWidth = '120px';
    usdCell.style.width = '120px';
    usdCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    usdCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    if (monthIndex > 0) {
      usdCell.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    charterProfitRow.appendChild(usdCell);

    const aedCell = document.createElement('td');
    aedCell.textContent = data.AED.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    aedCell.style.textAlign = 'right';
    aedCell.style.fontWeight = '600';
    aedCell.style.minWidth = '120px';
    aedCell.style.width = '120px';
    aedCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    aedCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    charterProfitRow.appendChild(aedCell);
  });

  tbody.appendChild(charterProfitRow);

  // Add Total profit row (after Charter profit)
  const totalProfitRow = document.createElement('tr');
  totalProfitRow.style.backgroundColor = 'hsl(210, 11%, 98%)';
  totalProfitRow.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  
  const totalProfitCategoryCell = document.createElement('td');
  totalProfitCategoryCell.textContent = 'Total profit';
  totalProfitCategoryCell.style.fontWeight = '700';
  totalProfitCategoryCell.style.position = 'sticky';
  totalProfitCategoryCell.style.left = '0';
  totalProfitCategoryCell.style.zIndex = '90';
  totalProfitCategoryCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
  totalProfitCategoryCell.style.borderRight = '2px solid hsl(210, 11%, 85%)';
  totalProfitCategoryCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
  totalProfitRow.appendChild(totalProfitCategoryCell);

  months.forEach((monthKey, monthIndex) => {
    // Calculate total expenses for this month
    let totalExpensesUSD = 0;
    let totalExpensesAED = 0;
    allCategories.forEach(({ category, source }) => {
      const categoryData = source === 'nonFlight' ? categoryGroups.nonFlight[category] : categoryGroups.flight[category];
      const data = categoryData[monthKey] || { USD: 0, AED: 0 };
      totalExpensesUSD += data.USD;
      totalExpensesAED += data.AED;
    });

    // Get Charter profit for this month
    const charterProfitData = incomeItems.charterProfit[monthKey] || { USD: 0, AED: 0 };
    
    // Total profit = Charter profit - Total expenses
    const totalProfitUSD = charterProfitData.USD - totalExpensesUSD;
    const totalProfitAED = charterProfitData.AED - totalExpensesAED;
    
    const usdCell = document.createElement('td');
    usdCell.textContent = totalProfitUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    usdCell.style.textAlign = 'right';
    usdCell.style.fontWeight = '700';
    usdCell.style.minWidth = '120px';
    usdCell.style.width = '120px';
    usdCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    usdCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    if (monthIndex > 0) {
      usdCell.style.borderLeft = '2px solid hsl(210, 6%, 21%)';
    }
    totalProfitRow.appendChild(usdCell);

    const aedCell = document.createElement('td');
    aedCell.textContent = totalProfitAED.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    aedCell.style.textAlign = 'right';
    aedCell.style.fontWeight = '700';
    aedCell.style.minWidth = '120px';
    aedCell.style.width = '120px';
    aedCell.style.backgroundColor = 'hsl(210, 11%, 98%)';
    aedCell.style.borderTop = '2px solid hsl(210, 6%, 21%)';
    totalProfitRow.appendChild(aedCell);
  });

  tbody.appendChild(totalProfitRow);

  // Update table header position after rendering
  // Use multiple timeouts to ensure DOM is fully updated and heights are calculated
  setTimeout(() => {
    updateTableHeaderPosition();
    // Call again after a short delay to ensure correct positioning
    setTimeout(updateTableHeaderPosition, 100);
  }, 50);
}

// Show expense details modal
function showExpenseDetails(category, monthKey, currency) {
  try {
    console.log('showExpenseDetails called:', { category, monthKey, currency });
    const detailKey = `${category}_${monthKey}`;
    console.log('Looking for detailKey:', detailKey);
    console.log('expenseDetailsMap keys:', Object.keys(expenseDetailsMap));
    const expenses = expenseDetailsMap[detailKey] || [];
    console.log('Found expenses for', detailKey, ':', expenses.length);
    
    const modal = document.getElementById('expenseDetailsModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalContent = document.getElementById('expenseDetailsContent');
    
    if (!modal) {
      console.error('Modal element not found');
      alert('Modal element not found');
      return;
    }
    
    if (!modalTitle || !modalContent) {
      console.error('Modal title or content not found');
      return;
    }
    
    if (expenses.length === 0) {
      console.log('No expenses found for this cell');
      alert(`No expenses found for ${category} in ${monthKey}`);
      return;
    }
  
  const [year, month] = monthKey.split('-');
  const monthName = new Date(parseInt(year), parseInt(month) - 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  
  modalTitle.textContent = `${category} - ${monthName} (${currency})`;
  
  // Filter expenses for this category
  // Category can be either base category or category with subtype
  const filteredExpenses = expenses.filter(({ expense }) => {
    if (showSubcategories) {
      // When showing subcategories, compare with full category (with subtype)
      const fullCategory = getExpenseCategory(expense);
      return fullCategory === category;
    } else {
      // When showing base categories, compare with base category only
      const baseCategory = getBaseExpenseCategory(expense);
      return baseCategory === category;
    }
  });
  
  // Calculate totals
  let totalOriginal = 0;
  let totalConverted = 0;
  
  filteredExpenses.forEach(({ expense, amount, currency: expCurrency, monthlyAmount }) => {
    if (expCurrency === currency) {
      totalOriginal += monthlyAmount;
    } else {
      totalConverted += convertCurrency(monthlyAmount, expCurrency, currency);
    }
  });
  
  const total = totalOriginal + totalConverted;
  
  // Build content
  let content = `
    <div style="margin-bottom: 1.5rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background-color: hsl(210, 11%, 98%); border-radius: 0.5rem; margin-bottom: 1rem;">
        <div>
          <div style="font-size: 0.875rem; color: hsl(210, 6%, 46%); margin-bottom: 0.25rem;">Total Amount</div>
          <div style="font-size: 1.5rem; font-weight: 600; color: hsl(210, 6%, 21%);">
            ${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}
          </div>
        </div>
        <div style="text-align: right;">
          <div style="font-size: 0.875rem; color: hsl(210, 6%, 46%);">Number of Expenses</div>
          <div style="font-size: 1.25rem; font-weight: 600; color: hsl(210, 6%, 21%);">
            ${filteredExpenses.length}
          </div>
        </div>
      </div>
    </div>
    
    <div style="margin-bottom: 1rem;">
      <table style="width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.875rem; table-layout: auto;">
        <thead>
          <tr style="background-color: hsl(210, 11%, 96%); border-bottom: 2px solid hsl(210, 11%, 90%);">
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 140px; font-size: 0.8125rem;">Expense Subtype</th>
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 100px; font-size: 0.8125rem;">Invoice #</th>
            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 220px; font-size: 0.8125rem;">Full Amount</th>
            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 200px; font-size: 0.8125rem;">Original Amount</th>
            <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 180px; font-size: 0.8125rem;">USD Amount</th>
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 180px; font-size: 0.8125rem;">Period</th>
            <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: hsl(210, 6%, 21%); font-size: 0.8125rem; min-width: 350px;">Comments</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  // Calculate total for USD Amount
  let totalMonthlyUSD = 0;
  
  // Render all expenses in one table
  filteredExpenses.forEach(({ expense, amount, currency: expCurrency, monthlyAmount }) => {
      const expenseType = expense.exp_type || 'N/A';
      const expenseSubtype = expense.exp_subtype || '—';
      const invoiceNumber = expense.invoices?.inv_number || 'N/A';
      const invoiceId = expense.exp_invoice || null;
      const comments = expense.exp_comments || '—';
      
      // Full amount in original currency (not monthly) - from invoice
      const fullAmount = parseFloat(amount) || 0;
      const fullAmountFormatted = fullAmount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      // Monthly amount in original currency (portion for this specific month)
      const monthlyAmountOriginal = parseFloat(monthlyAmount) || 0;
      const monthlyAmountOriginalFormatted = monthlyAmountOriginal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      // Monthly amount in USD
      const monthlyAmountUSD = convertCurrency(monthlyAmountOriginal, expCurrency, 'USD');
      const monthlyAmountUSDFormatted = monthlyAmountUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      
      // Add to total
      totalMonthlyUSD += monthlyAmountUSD;
      
      // Format route if flight exists
      let routeDisplay = '';
      if (expense.flights && expense.flights.flt_dep && expense.flights.flt_arr) {
        routeDisplay = `${expense.flights.flt_dep} - ${expense.flights.flt_arr}`;
      }
      
      // Full amount with route
      const fullAmountWithRoute = routeDisplay 
        ? `${fullAmountFormatted} ${expCurrency} (${routeDisplay})`
        : `${fullAmountFormatted} ${expCurrency}`;
      
      // Format period - show range only if multiple months
      let period = 'N/A';
      if (expense.exp_period_start && expense.exp_period_end) {
        const startDate = new Date(expense.exp_period_start);
        const endDate = new Date(expense.exp_period_end);
        
        // Check if this is a single month period
        const startMonth = startDate.getMonth();
        const startYear = startDate.getFullYear();
        const endMonth = endDate.getMonth();
        const endYear = endDate.getFullYear();
        
        // If period is within the same month, show only one month
        const isSingleMonth = (startYear === endYear && startMonth === endMonth);
        
        const startDateFormatted = startDate.toLocaleDateString('en-US', { 
          month: 'short', 
          year: 'numeric' 
        });
        
        if (isSingleMonth) {
          // Single month - show only start month
          period = startDateFormatted;
        } else {
          // Multiple months - show range
          const endDateFormatted = endDate.toLocaleDateString('en-US', { 
            month: 'short', 
            year: 'numeric' 
          });
          period = `${startDateFormatted} - ${endDateFormatted}`;
        }
      } else if (expense.flights?.flt_date) {
        period = new Date(expense.flights.flt_date).toLocaleDateString('en-US');
      }
      
      // Create invoice link if invoice ID exists - link to specific expense in invoice
      const expenseId = expense.id || null;
      const invoiceCell = invoiceId && expenseId
        ? `<a href="/invoices/${invoiceId}?expense=${expenseId}" style="color: hsl(210, 76%, 36%); text-decoration: underline; cursor: pointer;">${invoiceNumber}</a>`
        : invoiceId
        ? `<a href="/invoices/${invoiceId}" style="color: hsl(210, 76%, 36%); text-decoration: underline; cursor: pointer;">${invoiceNumber}</a>`
        : invoiceNumber;
      
    content += `
      <tr style="border-bottom: 1px solid hsl(210, 11%, 90%);">
        <td style="padding: 0.75rem; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 140px;">${expenseSubtype}</td>
        <td style="padding: 0.75rem; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 100px;">${invoiceCell}</td>
        <td style="padding: 0.75rem; text-align: right; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 220px;">${fullAmountWithRoute}</td>
        <td style="padding: 0.75rem; text-align: right; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 200px;">${monthlyAmountOriginalFormatted} ${expCurrency}</td>
        <td style="padding: 0.75rem; text-align: right; color: hsl(210, 6%, 21%); font-weight: 500; white-space: nowrap; min-width: 180px;">$${monthlyAmountUSDFormatted}</td>
        <td style="padding: 0.75rem; color: hsl(210, 6%, 46%); font-size: 0.8125rem; white-space: nowrap; min-width: 180px;">${period}</td>
        <td style="padding: 0.75rem; color: hsl(210, 6%, 46%); font-size: 0.8125rem; word-wrap: break-word; min-width: 350px;">${comments}</td>
      </tr>
    `;
  });
  
  // Add total row
  const totalMonthlyUSDFormatted = totalMonthlyUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  
  content += `
      <tr style="border-top: 2px solid hsl(210, 11%, 90%); background-color: hsl(210, 11%, 98%);">
        <td colspan="4" style="padding: 0.75rem; text-align: right; font-weight: 600; color: hsl(210, 6%, 21%);">Total:</td>
        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: hsl(210, 6%, 21%); white-space: nowrap; min-width: 180px;">$${totalMonthlyUSDFormatted}</td>
        <td colspan="2" style="padding: 0.75rem;"></td>
      </tr>
        </tbody>
      </table>
    </div>
  `;
  
    modalContent.innerHTML = content;
    console.log('Setting modal display to flex');
    
    // Use the same approach as other modals in the app
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    console.log('Modal display style:', modal.style.display);
    console.log('Modal element:', modal);
    console.log('Modal computed style:', window.getComputedStyle(modal).display);
    console.log('Modal classList:', modal.classList);
  } catch (error) {
    console.error('Error in showExpenseDetails:', error);
    alert('Error opening expense details: ' + error.message);
  }
}

// Close expense details modal
function closeExpenseDetailsModal() {
  const modal = document.getElementById('expenseDetailsModal');
  if (modal) {
    modal.classList.remove('show');
    document.body.style.overflow = 'auto';
  }
}

// Export expenses report to Excel (server-side)
async function exportToExcel() {
  const exportBtn = document.getElementById('exportExcelBtn');
  const originalText = exportBtn ? exportBtn.innerHTML : '';
  
  try {
    // Show loading state
    if (exportBtn) {
      exportBtn.disabled = true;
      exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exporting...';
    }

    // Get year filter value
    const yearFilter = document.getElementById('yearFilter')?.value || 'current';
    
    // Make request to server endpoint
    const response = await fetch(`/api/expenses/export-excel?year=${yearFilter}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
      throw new Error(errorData.error || `Server error: ${response.status}`);
    }

    // Get filename from Content-Disposition header or generate one
    const contentDisposition = response.headers.get('Content-Disposition');
    let filename = `Expenses_Report_${yearFilter === 'all' ? 'AllYears' : yearFilter}_${new Date().toISOString().split('T')[0]}.xlsx`;
    
    if (contentDisposition) {
      // Try to extract filename from Content-Disposition header
      // Support both filename="..." and filename*=UTF-8''...
      const filenameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/i) || 
                           contentDisposition.match(/filename="?([^";]+)"?/i);
      if (filenameMatch && filenameMatch[1]) {
        filename = decodeURIComponent(filenameMatch[1]);
      }
    }

    // Ensure filename has .xlsx extension
    if (!filename.toLowerCase().endsWith('.xlsx')) {
      filename = filename.replace(/\.xlsx_?$/i, '') + '.xlsx';
    }

    // Get blob and create download link
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    
    // Clean up after a short delay
    setTimeout(() => {
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);

    console.log('Excel file exported successfully');
    
    // Restore button state
    if (exportBtn) {
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    alert('Error exporting to Excel: ' + (error instanceof Error ? error.message : 'Unknown error'));
    
    // Restore button state on error
    if (exportBtn) {
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalText || '<i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel';
    }
  }
}

// Update table header position (similar to flights/expenses.ejs)
function updateTableHeaderPosition() {
  const header = document.querySelector('.header');
  const pageHeader = document.querySelector('.page-header');
  const table = document.querySelector('.expenses-report-table');

  if (!header || !pageHeader || !table) {
    return;
  }

  // Calculate total height of fixed headers above table
  const headerHeight = header.offsetHeight || 0;
  const pageHeaderHeight = pageHeader.offsetHeight || 0;
  const totalHeight = headerHeight + pageHeaderHeight;

  // Get all header rows
  const firstRowHeaders = table.querySelectorAll('thead tr:first-child th');
  const secondRowHeaders = table.querySelectorAll('thead tr:last-child th');
  
  if (firstRowHeaders.length === 0) {
    return;
  }

  // Get first row height - force layout calculation
  const firstRowHeight = firstRowHeaders[0].offsetHeight || 0;
  
  // Only log once to avoid spam
  if (!window.headerPositionLogged) {
    console.log('[Header Position]', {
      headerHeight,
      pageHeaderHeight,
      totalHeight,
      firstRowHeight,
      firstRowTop: totalHeight,
      secondRowTop: totalHeight + firstRowHeight
    });
    window.headerPositionLogged = true;
  }
  
  // Set top for first row headers (months and category)
  firstRowHeaders.forEach((th, index) => {
    th.style.top = totalHeight + 'px';
    // Only Category (first column) should have left: 0
    if (index === 0) {
      th.style.left = '0';
      th.style.zIndex = '102';
    } else {
      th.style.zIndex = '101';
    }
  });

  // Set top for second row headers (USD/AED)
  if (secondRowHeaders.length > 0) {
    secondRowHeaders.forEach((th) => {
      th.style.top = (totalHeight + firstRowHeight) + 'px';
      th.style.zIndex = '101';
    });
  }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
  loadExpensesReport();

  // Add year filter change handler
  const yearFilter = document.getElementById('yearFilter');
  if (yearFilter) {
    yearFilter.addEventListener('change', async function() {
      if (allExpensesData) {
        // Reprocess data with current settings
        await processExpensesData(allExpensesData);
      }
    });
  }

  // Add subcategories checkbox handler
  const showSubcategoriesCheckbox = document.getElementById('showSubcategories');
  if (showSubcategoriesCheckbox) {
    showSubcategoriesCheckbox.addEventListener('change', async function() {
      showSubcategories = this.checked;
      if (allExpensesData) {
        // Reprocess data with new subcategories setting
        await processExpensesData(allExpensesData);
      }
    });
  }

  // Add Excel export button handler
  const exportExcelBtn = document.getElementById('exportExcelBtn');
  if (exportExcelBtn) {
    exportExcelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      exportToExcel();
    });
  }

  // Add modal close handlers
  const closeModalBtn = document.getElementById('closeDetailsModalBtn');
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeExpenseDetailsModal);
  }
  
  const modal = document.getElementById('expenseDetailsModal');
  if (modal) {
    modal.addEventListener('click', function(e) {
      if (e.target === modal) {
        closeExpenseDetailsModal();
      }
    });
  }

  // Update header position on resize and after table render
  let resizeTimeout;
  window.addEventListener('resize', function() {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(updateTableHeaderPosition, 100);
  });
});
</script>

<style>
.page-content {
  padding-top: 0.5rem !important;
}

.page-header {
  position: sticky !important;
  top: 4rem !important;
  z-index: 90 !important;
  background-color: hsl(210, 11%, 98%) !important;
  padding: 0.5rem 0 !important;
  margin-bottom: 0.5rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
}

.expenses-report-table {
  width: 100% !important;
  border-collapse: separate !important;
  border-spacing: 0 !important;
  font-size: 0.8rem !important;
  table-layout: auto !important;
  min-width: max-content !important;
}

.expenses-report-table thead {
  background-color: hsl(210, 11%, 96%) !important;
  position: relative !important;
}

.expenses-report-table th {
  padding: 0.5rem 0.75rem !important;
  text-align: left !important;
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  border-right: 1px solid hsl(210, 11%, 90%) !important;
  white-space: nowrap !important;
  background-color: hsl(210, 11%, 96%) !important;
  min-width: 120px !important;
}

/* Sticky headers - top will be set by JavaScript */
.expenses-report-table thead th {
  position: sticky !important;
  background-color: hsl(210, 11%, 96%) !important;
  top: 0 !important; /* Default, will be overridden by JavaScript */
}

/* Category column - sticky both horizontally and vertically */
.expenses-report-table thead th:first-child {
  left: 0 !important;
  z-index: 102 !important;
  border-right: 2px solid hsl(210, 11%, 85%) !important;
}

/* All other headers - sticky only vertically */
.expenses-report-table thead th:not(:first-child) {
  z-index: 101 !important;
}

.expenses-report-table th:last-child {
  border-right: none !important;
}

.expenses-report-table td {
  padding: 0.5rem 0.75rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  border-right: 1px solid hsl(210, 11%, 90%) !important;
  vertical-align: middle !important;
  color: hsl(210, 6%, 21%) !important;
  white-space: nowrap !important;
  min-width: 120px !important;
  width: 120px !important;
  max-width: 120px !important;
  font-size: 0.75rem !important;
}

.expenses-report-table td:last-child {
  border-right: none !important;
}

/* Only Category column should be sticky horizontally */
.expenses-report-table td:first-child {
  font-weight: 500 !important;
  min-width: 220px !important;
  max-width: 350px !important;
  width: auto !important;
  position: sticky !important;
  left: 0 !important;
  z-index: 90 !important;
  border-right: 2px solid hsl(210, 11%, 85%) !important;
  white-space: normal !important;
  word-wrap: break-word !important;
}

.expenses-report-table tbody tr:hover {
  opacity: 0.9;
}

.expenses-report-table tbody tr:hover td {
  opacity: 0.9;
}

.expenses-report-table .group-header td {
  padding: 0.75rem 0.5rem !important;
  font-size: 0.875rem !important;
}

.table-wrapper {
  overflow-x: auto !important;
  overflow-y: auto !important;
  max-height: 70vh !important;
  width: 100% !important;
}

.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem;
  min-height: 300px;
}

.loading-text {
  margin-top: 1rem;
  color: hsl(210, 6%, 46%);
  font-size: 0.875rem;
}

/* Modal styles */
.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: none !important;
  justify-content: center !important;
  align-items: center !important;
  z-index: 10000 !important;
}

.modal-overlay[style*="display: flex"],
.modal-overlay.show {
  display: flex !important;
}

.modal-container {
  background: white !important;
  border-radius: 0.75rem !important;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  width: 90% !important;
  max-width: 1200px !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
}

.modal-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 1.5rem 1.5rem 0 1.5rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  margin-bottom: 1.5rem !important;
}

.modal-header h3 {
  margin: 0 !important;
  font-size: 1.25rem !important;
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-close {
  background: none !important;
  border: none !important;
  font-size: 1.25rem !important;
  color: hsl(210, 6%, 46%) !important;
  cursor: pointer !important;
  padding: 0.25rem !important;
  border-radius: 0.25rem !important;
  transition: all 0.2s ease !important;
}

.modal-close:hover {
  background-color: hsl(210, 11%, 95%) !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-body {
  padding: 0 1.5rem 1.5rem 1.5rem !important;
}
</style>


