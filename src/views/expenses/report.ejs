<div class="page-header" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
  <div class="table-actions" style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
    <button id="exportExcelBtn" class="btn btn-primary" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; white-space: nowrap;">
      <i class="bi bi-file-earmark-spreadsheet"></i>
      Export to Excel
    </button>
    <button id="unassignedExpensesBtn" class="btn btn-secondary" disabled style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; font-size: 0.875rem; white-space: nowrap;">
      <i class="bi bi-exclamation-triangle"></i>
      Unassigned expenses (0)
    </button>
  </div>
</div>

<div class="table-container">
  <div class="table-card">
    <div class="table-wrapper">
      <table class="invoices-table expenses-report-table" id="expensesReportTable">
        <thead id="expensesReportHead"></thead>
        <tbody id="expensesReportBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="unassignedExpensesModal" class="modal-overlay" style="display: none;">
  <div class="modal-container modal-wide">
    <div class="modal-header">
      <h3>Unassigned expenses</h3>
      <button class="modal-close" id="closeUnassignedModalBtn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body" id="unassignedExpensesContent"></div>
  </div>
</div>

<div id="expenseDetailsModal" class="modal-overlay" style="display: none;">
  <div class="modal-container modal-wide">
    <div class="modal-header">
      <h3 id="expenseDetailsTitle">Details</h3>
      <button class="modal-close" id="closeExpenseDetailsBtn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body" id="expenseDetailsContent"></div>
  </div>
</div>

<script>
const CURRENCY_RATES = {
  AED_TO_USD: 3.6735,
  AED_TO_EUR: 4.3119,
};

const MONTH_COUNT = 6;

const EXPENSE_CATEGORIES = [
  'CAMO and Management',
  'Flight planning',
  'Subscriptions',
  'Maintenance',
  'Insurance charge',
  'Crew',
  'FalconCare',
  'Honeywell',
  'Ground handling',
  'Fuel',
  'Navigation charges',
  'Overfly charges',
  'Catering',
  'Other charges',
];

const INCOME_TYPES = {
  creditNote: 'Credit note',
  charterProfit: 'Charter profit',
};

let expenseDetailsMap = {};
let feeMonthsCache = new Map();

function getCategoryGroup(category) {
  const group1 = [
    'CAMO and Management',
    'Flight planning',
    'Subscriptions',
    'Maintenance',
    'Insurance charge',
    'Crew',
  ];
  const group2 = ['FalconCare', 'Honeywell'];
  const group3 = [
    'Ground handling',
    'Fuel',
    'Navigation charges',
    'Overfly charges',
    'Catering',
    'Other charges',
  ];

  if (group1.includes(category)) return 1;
  if (group2.includes(category)) return 2;
  if (group3.includes(category)) return 3;
  return 0;
}

function convertCurrency(amount, fromCurrency, toCurrency) {
  if (!amount || !fromCurrency || !toCurrency) return 0;
  if (fromCurrency === toCurrency) return amount;

  if (fromCurrency === 'EUR') {
    const amountInAED = amount * CURRENCY_RATES.AED_TO_EUR;
    if (toCurrency === 'AED') {
      return amountInAED;
    }
    if (toCurrency === 'USD') {
      return amountInAED / CURRENCY_RATES.AED_TO_USD;
    }
  }

  if (toCurrency === 'EUR') {
    let amountInAED = 0;
    if (fromCurrency === 'USD') {
      amountInAED = amount * CURRENCY_RATES.AED_TO_USD;
    } else if (fromCurrency === 'AED') {
      amountInAED = amount;
    }
    return amountInAED / CURRENCY_RATES.AED_TO_EUR;
  }

  let amountInUSD = amount;
  if (fromCurrency === 'AED') {
    amountInUSD = amount / CURRENCY_RATES.AED_TO_USD;
  }

  if (toCurrency === 'USD') {
    return amountInUSD;
  }
  if (toCurrency === 'AED') {
    return amountInUSD * CURRENCY_RATES.AED_TO_USD;
  }

  return amount;
}

function normalizeExpenseType(expense) {
  const type = (expense.exp_type || '').toLowerCase();

  if (type === 'camo and management' || (type.includes('camo') && type.includes('management'))) {
    return 'CAMO and Management';
  }
  if (type.includes('flight planning') || type.includes('flightplanning')) {
    return 'Flight planning';
  }
  if (type === 'subscriptions' || type.includes('subscription')) {
    return 'Subscriptions';
  }
  if (type === 'maintenance') {
    return 'Maintenance';
  }
  if (type === 'insurance charge' || type.includes('insurance')) {
    return 'Insurance charge';
  }
  if (type === 'crew') {
    return 'Crew';
  }
  if (type === 'falconcare' || type.includes('falcon care')) {
    return 'FalconCare';
  }
  if (type === 'honeywell') {
    return 'Honeywell';
  }
  if (type === 'ground handling' || type.includes('groundhandling')) {
    return 'Ground handling';
  }
  if (type === 'fuel') {
    return 'Fuel';
  }
  if (type === 'navigation charges' || type.includes('navigation') || type.includes('enroute')) {
    return 'Navigation charges';
  }
  if (type === 'overfly charges' || type.includes('overfly') || type.includes('overflight')) {
    return 'Overfly charges';
  }
  if (type === 'catering' || type.includes('catering') || type.includes('food')) {
    return 'Catering';
  }
  if (type === 'other charges' || type.includes('other charges')) {
    return 'Other charges';
  }

  return null;
}

function isDisbursementFee(expense) {
  const type = (expense.exp_type || '').toLowerCase();
  return type === 'disbursement fee' || type.includes('disbursement');
}

function isIncomeItem(expense) {
  const expCategory = expense.exp_category || 'expense';
  const invoiceTypeName = expense.invoice_types?.name || expense.exp_invoice_type || '';
  const invoiceTypeNameLower = (typeof invoiceTypeName === 'string' ? invoiceTypeName : '').toLowerCase().trim();
  const expTypeLower = ((expense.exp_type || '') + '').toLowerCase();

  const isCreditNote = (
    expCategory === 'income_credit_note' ||
    (invoiceTypeNameLower.includes('credit') && invoiceTypeNameLower.includes('note'))
  );

  const isCharterProfit = (
    expCategory === 'income_charter_profit' ||
    (invoiceTypeNameLower.includes('charter') && invoiceTypeNameLower.includes('profit')) ||
    (expTypeLower.includes('charter') && expTypeLower.includes('profit'))
  );

  if (isCreditNote) {
    return 'creditNote';
  }
  if (isCharterProfit) {
    return 'charterProfit';
  }
  return null;
}

function getMonthKey(date) {
  return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
}

function splitExpenseByPeriod(expense) {
  const amount = parseFloat(expense.exp_amount) || 0;
  const currency = expense.exp_currency || 'USD';
  const periodStart = expense.exp_period_start;
  const periodEnd = expense.exp_period_end;

  if (!periodStart || !periodEnd) {
    return [];
  }

  const start = new Date(periodStart);
  const end = new Date(periodEnd);
  const months = [];

  const startYear = start.getFullYear();
  const startMonth = start.getMonth();
  const endYear = end.getFullYear();
  const endMonth = end.getMonth();
  const endDay = end.getDate();

  const isSingleMonth = (
    endDay === 1 &&
    ((endMonth === (startMonth + 1) % 12 && endYear === startYear) ||
     (endMonth === 0 && endYear === startYear + 1))
  );

  let totalMonths;
  if (isSingleMonth) {
    totalMonths = 1;
  } else {
    totalMonths = (endYear - startYear) * 12 + (endMonth - startMonth) + 1;
  }

  const monthlyAmount = totalMonths > 0 ? amount / totalMonths : amount;
  let currentYear = startYear;
  let currentMonth = startMonth;

  for (let i = 0; i < totalMonths; i++) {
    const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
    months.push({ monthKey, amount: monthlyAmount, currency });
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
  }

  return months;
}

function getExpenseMonths(expense) {
  const hasPeriod = !!(expense.exp_period_start && expense.exp_period_end);
  const hasFlight = !!(expense.exp_flight && expense.flights && expense.flights.flt_date);

  if (hasPeriod && hasFlight) {
    return { months: [], invalidReason: 'Expense has both period and flight' };
  }

  if (hasPeriod) {
    return { months: splitExpenseByPeriod(expense), invalidReason: null };
  }

  if (hasFlight) {
    const flightDate = new Date(expense.flights.flt_date);
    return {
      months: [{ monthKey: getMonthKey(flightDate), amount: parseFloat(expense.exp_amount) || 0, currency: expense.exp_currency || 'USD' }],
      invalidReason: null,
    };
  }

  return { months: [], invalidReason: 'Expense has no period and no flight' };
}

function findRelatedDisbursementFees(expense, fees) {
  const matches = [];

  for (const fee of fees) {
    if (!isDisbursementFee(fee)) {
      continue;
    }

    if (expense.exp_invoice) {
      if (fee.exp_invoice !== expense.exp_invoice) {
        continue;
      }
    } else if (fee.exp_invoice) {
      continue;
    }

    if (expense.exp_flight) {
      if (fee.exp_flight !== expense.exp_flight) {
        continue;
      }
    } else if (fee.exp_flight !== null) {
      continue;
    }

    if (expense.exp_period_start && expense.exp_period_end) {
      if (fee.exp_period_start !== expense.exp_period_start ||
          fee.exp_period_end !== expense.exp_period_end) {
        continue;
      }
    } else if (fee.exp_period_start !== null || fee.exp_period_end !== null) {
      continue;
    }

    if (expense.exp_place) {
      if (fee.exp_place !== expense.exp_place) {
        continue;
      }
    } else if (fee.exp_place !== null) {
      continue;
    }

    matches.push(fee);
  }

  return matches;
}

function normalizeAmountString(value) {
  const amount = parseFloat(value);
  if (Number.isNaN(amount)) return null;
  return amount.toFixed(2);
}

function getFeeMonthsSet(fee) {
  if (!feeMonthsCache.has(fee.id)) {
    return null;
  }
  return feeMonthsCache.get(fee.id);
}

function feeMatchesExpenseComment(fee, expense, monthKey) {
  const comment = (fee.exp_comments || '').toLowerCase();
  if (!comment) return false;

  const type = (expense.exp_type || '').toLowerCase();
  const subtype = (expense.exp_subtype || '').toLowerCase();

  const expenseDescription = (expense.exp_comments || '').toLowerCase().trim();
  if (expenseDescription && !comment.includes(expenseDescription)) {
    return false;
  }
  if (!expenseDescription) {
    if (type && !comment.includes(type)) {
      return false;
    }
    if (subtype && !comment.includes(subtype)) {
      return false;
    }
  }

  const amountString = normalizeAmountString(expense.exp_amount);
  const currency = (expense.exp_currency || '').toLowerCase();
  if (amountString && currency) {
    const amountToken = `${amountString} ${currency}`;
    if (!comment.includes(amountToken)) {
      return false;
    }
  }

  const feeMonths = getFeeMonthsSet(fee);
  if (!feeMonths || !feeMonths.has(monthKey)) {
    return false;
  }

  return true;
}

function getLastMonths(count) {
  const now = new Date();
  const months = [];
  for (let i = count - 1; i >= 0; i--) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(getMonthKey(date));
  }
  return months;
}

function initTotals(categories, months) {
  const totals = {};
  categories.forEach(category => {
    totals[category] = {};
    months.forEach(month => {
      totals[category][month] = 0;
    });
  });
  return totals;
}

function formatAmount(value) {
  const absValue = Math.abs(value);
  const formatted = absValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  return `${value < 0 ? '-' : ''}$${formatted}`;
}

function escapeHtml(value) {
  return String(value)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}

function formatDisplayDate(value) {
  if (!value) return '—';
  const date = new Date(value);
  if (Number.isNaN(date.getTime())) return value;
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

function buildExpenseSummary(expense) {
  const invoiceId = expense.exp_invoice || null;
  const expenseId = expense.id || null;
  const invoiceNumber = expense.invoices?.inv_number || null;
  const invoiceLink = invoiceId
    ? (expenseId ? `/invoices/${invoiceId}?expense=${expenseId}` : `/invoices/${invoiceId}`)
    : null;

  return [
    { label: 'ID', value: expense.id },
    { label: 'Type', value: expense.exp_type },
    { label: 'Subtype', value: expense.exp_subtype },
    { label: 'Amount', value: expense.exp_amount },
    { label: 'Currency', value: expense.exp_currency },
    { label: 'Invoice ID', value: expense.exp_invoice },
    { label: 'Invoice', value: invoiceNumber, link: invoiceLink },
    { label: 'Period Start', value: expense.exp_period_start },
    { label: 'Period End', value: expense.exp_period_end },
    { label: 'Flight ID', value: expense.exp_flight },
    { label: 'Flight Date', value: expense.flights?.flt_date },
    { label: 'Comments', value: expense.exp_comments },
  ];
}

function renderUnassignedExpenses(list) {
  const content = document.getElementById('unassignedExpensesContent');
  const btn = document.getElementById('unassignedExpensesBtn');
  const count = list.length;

  if (btn) {
    btn.disabled = count === 0;
    btn.innerHTML = `<i class="bi bi-exclamation-triangle"></i> Unassigned expenses (${count})`;
  }

  if (!content) {
    return;
  }

  if (count === 0) {
    content.innerHTML = '<div class="empty-state">No unassigned expenses.</div>';
    return;
  }

  const rows = list.map(item => {
    const summaryRows = buildExpenseSummary(item.expense)
      .filter(field => field.value !== undefined && field.value !== null && field.value !== '')
      .map(field => {
        const value = escapeHtml(field.value);
        const content = field.link
          ? `<a class="summary-link" href="${escapeHtml(field.link)}">${value}</a>`
          : value;

        return `
          <div class="summary-row">
            <span class="summary-label">${escapeHtml(field.label)}:</span>
            <span class="summary-value">${content}</span>
          </div>
        `;
      })
      .join('');

    return `
      <tr>
        <td class="reason-col">${escapeHtml(item.reason)}</td>
        <td>
          <div class="summary-block">
            ${summaryRows || '<span class="summary-empty">No data</span>'}
          </div>
        </td>
      </tr>
    `;
  }).join('');

  content.innerHTML = `
    <table class="invoices-table unassigned-table">
      <thead>
        <tr>
          <th class="reason-col">Reason</th>
          <th>Expense data</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

function renderTable(months, categoryTotals, incomeTotals) {
  const thead = document.getElementById('expensesReportHead');
  const tbody = document.getElementById('expensesReportBody');

  thead.innerHTML = '';
  tbody.innerHTML = '';

  const headerRow = document.createElement('tr');
  const categoryHeader = document.createElement('th');
  categoryHeader.textContent = 'Category';
  headerRow.appendChild(categoryHeader);

  months.forEach(monthKey => {
    const [year, month] = monthKey.split('-');
    const monthName = new Date(parseInt(year), parseInt(month) - 1)
      .toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
    const th = document.createElement('th');
    th.textContent = monthName;
    headerRow.appendChild(th);
  });

  thead.appendChild(headerRow);

  EXPENSE_CATEGORIES.forEach(category => {
    const row = document.createElement('tr');
    const group = getCategoryGroup(category);
    row.classList.add(`category-group-${group}`);
    const label = document.createElement('td');
    label.textContent = category;
    row.appendChild(label);

    months.forEach(monthKey => {
      const value = categoryTotals[category][monthKey] || 0;
      const cell = document.createElement('td');
      cell.textContent = formatAmount(value);
      cell.className = 'amount-cell';
      cell.dataset.category = category;
      cell.dataset.month = monthKey;
      cell.dataset.rowType = 'expense';
      row.appendChild(cell);
    });
    tbody.appendChild(row);
  });

  Object.keys(INCOME_TYPES).forEach(typeKey => {
    const row = document.createElement('tr');
    row.className = 'income-row';
    const label = document.createElement('td');
    label.textContent = INCOME_TYPES[typeKey];
    row.appendChild(label);

    months.forEach(monthKey => {
      const value = incomeTotals[typeKey][monthKey] || 0;
      const cell = document.createElement('td');
      cell.textContent = formatAmount(value);
      cell.className = 'amount-cell income-cell';
      cell.dataset.category = INCOME_TYPES[typeKey];
      cell.dataset.month = monthKey;
      cell.dataset.rowType = 'income';
      row.appendChild(cell);
    });
    tbody.appendChild(row);
  });
}

function getDetailsKey(category, monthKey, rowType) {
  return `${rowType}:${category}:${monthKey}`;
}

function buildInvoiceLink(expense) {
  const invoiceId = expense.exp_invoice || null;
  const expenseId = expense.id || null;
  if (!invoiceId) {
    return null;
  }
  return expenseId ? `/invoices/${invoiceId}?expense=${expenseId}` : `/invoices/${invoiceId}`;
}

function renderExpenseDetails(category, monthKey, rowType) {
  const modal = document.getElementById('expenseDetailsModal');
  const title = document.getElementById('expenseDetailsTitle');
  const content = document.getElementById('expenseDetailsContent');

  if (!modal || !title || !content) {
    return;
  }

  const detailsKey = getDetailsKey(category, monthKey, rowType);
  const rows = expenseDetailsMap[detailsKey] || [];
  const [year, month] = monthKey.split('-');
  const monthName = new Date(parseInt(year), parseInt(month) - 1)
    .toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

  title.textContent = `${category} - ${monthName}`;

  if (rows.length === 0) {
    content.innerHTML = '<div class="empty-state">No expenses for this period.</div>';
  } else {
    let totalAmountUSD = 0;
    let totalFeeUSD = 0;
    let totalWithFeeUSD = 0;

    const bodyRows = rows.map(item => {
      totalAmountUSD += item.originalAmountUSD || 0;
      totalFeeUSD += item.feeUSD || 0;
      totalWithFeeUSD += item.totalUSD || 0;

      const invoiceLink = item.invoiceLink
        ? `<a class="summary-link" href="${escapeHtml(item.invoiceLink)}">${escapeHtml(item.invoiceNumber || item.invoiceId || 'Invoice')}</a>`
        : escapeHtml(item.invoiceNumber || item.invoiceId || '—');

      return `
        <tr>
          <td>${escapeHtml(item.type || '—')}</td>
          <td>${escapeHtml(item.subtype || '—')}</td>
          <td>${escapeHtml(item.flight || '—')}</td>
          <td>${escapeHtml(item.place || '—')}</td>
          <td>${invoiceLink}</td>
          <td class="amount-cell">${formatAmount(item.originalAmountUSD)}</td>
          <td class="amount-cell">${formatAmount(item.feeUSD)}</td>
          <td class="amount-cell">${formatAmount(item.totalUSD)}</td>
          <td>${escapeHtml(item.periodLabel || '—')}</td>
          <td>${escapeHtml(item.comments || '—')}</td>
        </tr>
      `;
    }).join('');

    content.innerHTML = `
      <table class="invoices-table">
        <thead>
          <tr>
            <th>Type</th>
            <th>Subtype</th>
            <th>Flight</th>
            <th>Place</th>
            <th>Invoice</th>
            <th>USD Amount</th>
            <th>Disbursement fee</th>
            <th>Total USD</th>
            <th>Period/Flight</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody>
          ${bodyRows}
          <tr class="details-total-row">
            <td colspan="5">Total</td>
            <td class="amount-cell">${formatAmount(totalAmountUSD)}</td>
            <td class="amount-cell">${formatAmount(totalFeeUSD)}</td>
            <td class="amount-cell">${formatAmount(totalWithFeeUSD)}</td>
            <td colspan="2"></td>
          </tr>
        </tbody>
      </table>
    `;
  }

  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
}

async function loadExpensesReport() {
  try {
    const response = await apiRequest('/api/expenses');
    const expenses = await response.json();

    if (!Array.isArray(expenses)) {
      throw new Error('Invalid expenses data format');
    }

    const months = getLastMonths(MONTH_COUNT);
    const categoryTotals = initTotals(EXPENSE_CATEGORIES, months);
    const incomeTotals = initTotals(Object.keys(INCOME_TYPES), months);
    const unassigned = [];
    const disbursementFees = expenses.filter(isDisbursementFee);
    const noInvoiceFees = disbursementFees.filter(fee => !fee.exp_invoice);
    const usedFeeIds = new Set();
    const feesByInvoice = {};
    expenseDetailsMap = {};
    feeMonthsCache = new Map();

    disbursementFees.forEach(fee => {
      const { months: feeMonths, invalidReason } = getExpenseMonths(fee);
      if (invalidReason) {
        unassigned.push({ reason: invalidReason, expense: fee });
        feeMonthsCache.set(fee.id, null);
      } else {
        feeMonthsCache.set(fee.id, new Set(feeMonths.map(item => item.monthKey)));
      }

      if (!fee.exp_invoice) {
        return;
      }
      if (!feesByInvoice[fee.exp_invoice]) {
        feesByInvoice[fee.exp_invoice] = [];
      }
      feesByInvoice[fee.exp_invoice].push(fee);
    });

    for (const expense of expenses) {
      const incomeType = isIncomeItem(expense);
      if (isDisbursementFee(expense)) {
        continue;
      }

      if (incomeType) {
        const { months: incomeMonths, invalidReason } = getExpenseMonths(expense);

        if (invalidReason) {
          unassigned.push({ reason: invalidReason, expense });
          continue;
        }

        if (!incomeMonths.length) {
          unassigned.push({ reason: 'Expense has no valid months', expense });
          continue;
        }

        const incomeMonthsInRange = incomeMonths.filter(({ monthKey }) => (monthKey in incomeTotals[incomeType]));
        if (incomeMonthsInRange.length === 0) {
          unassigned.push({ reason: 'Expense is outside visible range', expense });
          continue;
        }

        incomeMonthsInRange.forEach(({ monthKey, amount, currency }) => {
          const usdAmount = convertCurrency(amount, currency || 'USD', 'USD');
          incomeTotals[incomeType][monthKey] -= usdAmount;

          const detailKey = getDetailsKey(INCOME_TYPES[incomeType], monthKey, 'income');
          if (!expenseDetailsMap[detailKey]) {
            expenseDetailsMap[detailKey] = [];
          }

          const periodLabel = expense.exp_period_start && expense.exp_period_end
            ? `${formatDisplayDate(expense.exp_period_start)} - ${formatDisplayDate(expense.exp_period_end)}`
            : formatDisplayDate(expense.flights?.flt_date);

          expenseDetailsMap[detailKey].push({
            type: expense.exp_type,
            subtype: expense.exp_subtype,
            flight: expense.flights?.flt_number || expense.exp_flight,
            place: expense.exp_place,
            invoiceId: expense.exp_invoice,
            invoiceNumber: expense.invoices?.inv_number,
            invoiceLink: buildInvoiceLink(expense),
            originalAmountUSD: -usdAmount,
            feeUSD: 0,
            totalUSD: -usdAmount,
            periodLabel: periodLabel,
            comments: expense.exp_comments,
          });
        });
        continue;
      }

      const { months: expenseMonths, invalidReason } = getExpenseMonths(expense);

      if (invalidReason) {
        unassigned.push({ reason: invalidReason, expense });
        continue;
      }

      if (!expenseMonths.length) {
        unassigned.push({ reason: 'Expense has no valid months', expense });
        continue;
      }

      const category = normalizeExpenseType(expense);
      if (!category || !categoryTotals[category]) {
        unassigned.push({ reason: 'Expense has unknown category', expense });
        continue;
      }

      const expenseMonthsInRange = expenseMonths.filter(({ monthKey }) => (monthKey in categoryTotals[category]));
      if (expenseMonthsInRange.length === 0) {
        unassigned.push({ reason: 'Expense is outside visible range', expense });
        continue;
      }

      if (expense.exp_invoice) {
        const invoiceFees = feesByInvoice[expense.exp_invoice] || [];
        expenseMonthsInRange.forEach(({ monthKey, amount, currency }) => {
          const relatedFees = invoiceFees.filter(
            fee => !usedFeeIds.has(fee.id) && feeMatchesExpenseComment(fee, expense, monthKey)
          );
          let feeTotalUSD = 0;
          relatedFees.forEach(fee => {
            usedFeeIds.add(fee.id);
            const feeAmount = parseFloat(fee.exp_amount) || 0;
            feeTotalUSD += convertCurrency(feeAmount, fee.exp_currency || 'USD', 'USD');
          });

          const usdAmount = convertCurrency(amount, currency || 'USD', 'USD');
          categoryTotals[category][monthKey] += usdAmount + feeTotalUSD;

          const detailKey = getDetailsKey(category, monthKey, 'expense');
          if (!expenseDetailsMap[detailKey]) {
            expenseDetailsMap[detailKey] = [];
          }

          const periodLabel = expense.exp_period_start && expense.exp_period_end
            ? `${formatDisplayDate(expense.exp_period_start)} - ${formatDisplayDate(expense.exp_period_end)}`
            : formatDisplayDate(expense.flights?.flt_date);

          expenseDetailsMap[detailKey].push({
            type: expense.exp_type,
            subtype: expense.exp_subtype,
            flight: expense.flights?.flt_number || expense.exp_flight,
            place: expense.exp_place,
            invoiceId: expense.exp_invoice,
            invoiceNumber: expense.invoices?.inv_number,
            invoiceLink: buildInvoiceLink(expense),
            originalAmountUSD: usdAmount,
            feeUSD: feeTotalUSD,
            totalUSD: usdAmount + feeTotalUSD,
            periodLabel: periodLabel,
            comments: expense.exp_comments,
          });
        });
        continue;
      }

      const relatedFees = findRelatedDisbursementFees(expense, noInvoiceFees);
      let feeTotalUSD = 0;
      relatedFees.forEach(fee => {
        if (usedFeeIds.has(fee.id)) {
          return;
        }
        usedFeeIds.add(fee.id);
        const feeAmount = parseFloat(fee.exp_amount) || 0;
        feeTotalUSD += convertCurrency(feeAmount, fee.exp_currency || 'USD', 'USD');
      });

      const feePerMonth = expenseMonthsInRange.length ? feeTotalUSD / expenseMonthsInRange.length : 0;

      expenseMonthsInRange.forEach(({ monthKey, amount, currency }) => {
        const usdAmount = convertCurrency(amount, currency || 'USD', 'USD');
        categoryTotals[category][monthKey] += usdAmount + feePerMonth;

        const detailKey = getDetailsKey(category, monthKey, 'expense');
        if (!expenseDetailsMap[detailKey]) {
          expenseDetailsMap[detailKey] = [];
        }

        const periodLabel = expense.exp_period_start && expense.exp_period_end
          ? `${formatDisplayDate(expense.exp_period_start)} - ${formatDisplayDate(expense.exp_period_end)}`
          : formatDisplayDate(expense.flights?.flt_date);

        expenseDetailsMap[detailKey].push({
          type: expense.exp_type,
          subtype: expense.exp_subtype,
          flight: expense.flights?.flt_number || expense.exp_flight,
          place: expense.exp_place,
          invoiceId: expense.exp_invoice,
          invoiceNumber: expense.invoices?.inv_number,
          invoiceLink: buildInvoiceLink(expense),
          originalAmountUSD: usdAmount,
          feeUSD: feePerMonth,
          totalUSD: usdAmount + feePerMonth,
          periodLabel: periodLabel,
          comments: expense.exp_comments,
        });
      });
    }

    disbursementFees.forEach(fee => {
      if (!usedFeeIds.has(fee.id)) {
        unassigned.push({ reason: 'Disbursement fee has no matching expense', expense: fee });
      }
    });

    renderTable(months, categoryTotals, incomeTotals);
    renderUnassignedExpenses(unassigned);
  } catch (error) {
    console.error('Error loading expenses report:', error);
    const tbody = document.getElementById('expensesReportBody');
    tbody.innerHTML = `
      <tr>
        <td colspan="${MONTH_COUNT + 1}" style="text-align: center; padding: 2rem; color: #6b7280;">
          <i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
          Failed to load expenses report. Please try again.
        </td>
      </tr>
    `;
  }
}

// Export expenses report to Excel (server-side)
async function exportToExcel() {
  const exportBtn = document.getElementById('exportExcelBtn');
  const originalText = exportBtn ? exportBtn.innerHTML : '';

  try {
    if (exportBtn) {
      exportBtn.disabled = true;
      exportBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Exporting...';
    }

    const yearFilter = document.getElementById('yearFilter')?.value || 'current';
    const showSubcategories = document.getElementById('showSubcategories')?.checked || false;
    const reportForATS = document.getElementById('reportForATS')?.checked || false;

    const response = await fetch(`/api/expenses/export-excel?year=${yearFilter}&showSubcategories=${String(showSubcategories)}&reportForATS=${String(reportForATS)}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      },
      credentials: 'same-origin',
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
      throw new Error(errorData.error || `Server error: ${response.status}`);
    }

    const contentDisposition = response.headers.get('Content-Disposition');
    let filename = `Expenses_Report_${yearFilter === 'all' ? 'AllYears' : yearFilter}_${new Date().toISOString().split('T')[0]}.xlsx`;

    if (contentDisposition) {
      const filenameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/i) ||
                           contentDisposition.match(/filename="?([^";]+)"?/i);
      if (filenameMatch && filenameMatch[1]) {
        filename = decodeURIComponent(filenameMatch[1]);
      }
    }

    if (!filename.toLowerCase().endsWith('.xlsx')) {
      filename = filename.replace(/\.xlsx_?$/i, '') + '.xlsx';
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();

    setTimeout(() => {
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }, 100);

    if (exportBtn) {
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalText;
    }
  } catch (error) {
    console.error('Error exporting to Excel:', error);
    alert('Error exporting to Excel: ' + (error instanceof Error ? error.message : 'Unknown error'));

    if (exportBtn) {
      exportBtn.disabled = false;
      exportBtn.innerHTML = originalText || '<i class="bi bi-file-earmark-spreadsheet"></i> Export to Excel';
    }
  }
}

document.addEventListener('DOMContentLoaded', function() {
  loadExpensesReport();

  const exportExcelBtn = document.getElementById('exportExcelBtn');
  if (exportExcelBtn) {
    exportExcelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      exportToExcel();
    });
  }

  const unassignedBtn = document.getElementById('unassignedExpensesBtn');
  const unassignedModal = document.getElementById('unassignedExpensesModal');
  const closeUnassignedBtn = document.getElementById('closeUnassignedModalBtn');

  if (unassignedBtn && unassignedModal) {
    unassignedBtn.addEventListener('click', function(e) {
      e.preventDefault();
      unassignedModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    });
  }

  if (closeUnassignedBtn && unassignedModal) {
    closeUnassignedBtn.addEventListener('click', function() {
      unassignedModal.classList.remove('show');
      document.body.style.overflow = 'auto';
    });
  }

  if (unassignedModal) {
    unassignedModal.addEventListener('click', function(e) {
      if (e.target === unassignedModal) {
        unassignedModal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    });
  }

  const expenseDetailsModal = document.getElementById('expenseDetailsModal');
  const closeExpenseDetailsBtn = document.getElementById('closeExpenseDetailsBtn');

  if (closeExpenseDetailsBtn && expenseDetailsModal) {
    closeExpenseDetailsBtn.addEventListener('click', function() {
      expenseDetailsModal.classList.remove('show');
      document.body.style.overflow = 'auto';
    });
  }

  if (expenseDetailsModal) {
    expenseDetailsModal.addEventListener('click', function(e) {
      if (e.target === expenseDetailsModal) {
        expenseDetailsModal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    });
  }

  const reportTable = document.getElementById('expensesReportTable');
  if (reportTable) {
    reportTable.addEventListener('click', function(e) {
      const cell = e.target.closest('td');
      if (!cell || !cell.dataset.category || !cell.dataset.month) {
        return;
      }
      renderExpenseDetails(cell.dataset.category, cell.dataset.month, cell.dataset.rowType || 'expense');
    });
  }
});
</script>

<style>
.expenses-report-table th,
.expenses-report-table td {
  text-align: left !important;
}

.expenses-report-table .amount-cell {
  text-align: right !important;
  white-space: nowrap !important;
}

.expenses-report-table .income-row td {
  background-color: hsl(210, 11%, 98%) !important;
  font-weight: 600 !important;
}

.expenses-report-table .income-cell {
  color: hsl(142, 76%, 30%) !important;
}

.expenses-report-table .category-group-1 td {
  background-color: hsl(200, 50%, 96%) !important;
}

.expenses-report-table .category-group-2 td {
  background-color: hsl(280, 40%, 96%) !important;
}

.expenses-report-table .category-group-3 td {
  background-color: hsl(120, 30%, 97%) !important;
}

.invoices-table {
  width: 100% !important;
  border-collapse: collapse !important;
  font-size: 0.8rem !important;
  table-layout: fixed !important;
}

.invoices-table thead {
  background-color: hsl(210, 11%, 96%) !important;
}

.invoices-table th {
  padding: 0.5rem 0.5rem !important;
  text-align: left !important;
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  white-space: nowrap !important;
  font-size: 0.75rem !important;
}

.invoices-table td {
  padding: 0.5rem 0.5rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  vertical-align: middle !important;
}

.invoices-table tbody tr:hover {
  background-color: hsl(210, 11%, 98%) !important;
}

.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: none !important;
  justify-content: center !important;
  align-items: center !important;
  z-index: 10000 !important;
}

.modal-overlay.show {
  display: flex !important;
}

.modal-container {
  background: white !important;
  border-radius: 0.75rem !important;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  width: 90% !important;
  max-width: 1200px !important;
  max-height: 90vh !important;
  overflow-y: auto !important;
}

.modal-wide {
  max-width: 1300px !important;
}

.modal-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 1.5rem 1.5rem 0 1.5rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  margin-bottom: 1rem !important;
}

.modal-header h3 {
  margin: 0 !important;
  font-size: 1.25rem !important;
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-close {
  background: none !important;
  border: none !important;
  font-size: 1.25rem !important;
  color: hsl(210, 6%, 46%) !important;
  cursor: pointer !important;
  padding: 0.25rem !important;
  border-radius: 0.25rem !important;
  transition: all 0.2s ease !important;
}

.modal-close:hover {
  background-color: hsl(210, 11%, 95%) !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-body {
  padding: 0 1.5rem 1.5rem 1.5rem !important;
}

.unassigned-table .reason-col {
  width: 220px;
}

.summary-block {
  display: grid;
  gap: 0.35rem;
  font-size: 0.75rem;
  color: hsl(210, 6%, 21%);
}

.summary-row {
  display: grid;
  grid-template-columns: 160px 1fr;
  gap: 0.5rem;
}

.summary-label {
  color: hsl(210, 6%, 46%);
  font-weight: 600;
}

.summary-value {
  word-break: break-word;
}

.summary-link {
  color: hsl(210, 76%, 36%);
  text-decoration: underline;
}

.details-total-row td {
  font-weight: 600;
  background-color: hsl(210, 11%, 98%);
  border-top: 1px solid hsl(210, 11%, 85%);
}

.summary-empty {
  color: hsl(210, 6%, 46%);
}

.empty-state {
  color: hsl(210, 6%, 46%);
  padding: 1rem 0;
}
</style>


