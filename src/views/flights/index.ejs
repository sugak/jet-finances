<!-- Page Header -->
<div class="page-header">
  <div>
  </div>
</div>

<!-- Finance Cards -->
<div class="finance-cards" id="stats-cards">
  <!-- Completed Flights -->
  <div class="finance-card animation-delay-0">
    <div class="finance-card-content">
      <div class="finance-card-info">
        <h3 class="finance-card-title">Completed Flights</h3>
        <div class="finance-card-value-row">
          <span class="finance-card-value" id="completed-flights-value">0</span>
          <div class="metric-badge" id="completed-flights-badge" style="display: none;">
            <span class="metric-badge-text" id="completed-flights-percent">0%</span>
            <i class="bi" id="completed-flights-arrow"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Processed Invoices -->
  <div class="finance-card animation-delay-100">
    <div class="finance-card-content">
      <div class="finance-card-info">
        <h3 class="finance-card-title">Processed Invoices</h3>
        <div class="finance-card-value-row">
          <span class="finance-card-value" id="processed-invoices-value">0</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Discrepancies -->
  <div class="finance-card animation-delay-200">
    <div class="finance-card-content">
      <div class="finance-card-info">
        <h3 class="finance-card-title">Discrepancies</h3>
        <div class="finance-card-value-row">
          <span class="finance-card-value" id="discrepancies-open-value">0</span>
          <div class="metric-badge-secondary" id="discrepancies-total-badge">
            <span class="metric-badge-text-secondary" id="discrepancies-total-value">0</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Placeholder Card -->
  <div class="finance-card animation-delay-300">
    <div class="finance-card-content">
      <div class="finance-card-info">
        <h3 class="finance-card-title">—</h3>
        <div class="finance-card-value-row">
          <span class="finance-card-value">—</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Flights Table -->
<div class="table-container">
  <div class="table-card">
    <div class="table-header">
      <div class="table-title">
        <h3>Flight Operations</h3>
        <span class="table-subtitle">All scheduled and completed flights</span>
      </div>
      <div class="table-actions">
        <button class="btn btn-primary flights-action-btn" id="getScheduleBtn" style="margin-right: 0.5rem;">
          <i class="bi bi-calendar-check"></i>
          Get schedule
        </button>
        <a href="/expenses/report" class="btn btn-primary flights-action-btn" style="margin-right: 0.5rem;">
          <i class="bi bi-file-earmark-text"></i>
          Full report
        </a>
        <a href="/flights/expenses" class="btn btn-primary flights-action-btn" style="margin-right: 0.5rem;">
          <i class="bi bi-airplane"></i>
          Flight expenses
        </a>
        <% if (user && user.role === 'superadmin') { %>
        <button class="btn btn-primary" id="addFlightBtn">
          <i class="bi bi-plus-lg"></i>
          Add Flight
        </button>
        <% } else { %>
        <button class="btn btn-secondary" disabled title="Only superadmin can add flights">
          <i class="bi bi-plus-lg"></i>
          Add Flight
        </button>
        <% } %>
      </div>
    </div>
    
    <div class="table-wrapper">
      <table class="flights-table">
        <thead>
          <tr>
            <th class="checkbox-col">
              <input type="checkbox" class="form-check-input" id="selectAll">
            </th>
            <th class="sortable" id="dateSortHeader">
              DATE
              <i class="bi bi-chevron-up sort-icon" id="dateSortIcon"></i>
            </th>
            <th class="sortable">
              FLIGHT NO
              <i class="bi bi-chevron-down sort-icon"></i>
            </th>
            <th class="sortable">
              ROUTE
              <i class="bi bi-chevron-down sort-icon"></i>
            </th>
            <th class="sortable">
              FLIGHT TIME
              <i class="bi bi-chevron-down sort-icon"></i>
            </th>
            <th class="sortable">
              BLOCK TIME
              <i class="bi bi-chevron-down sort-icon"></i>
            </th>
            <th>STATUS</th>
            <th>EXPENSES</th>
            <th>COMMENTS</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody id="flights-table-body">
          <!-- Data will be loaded via JavaScript -->
        </tbody>
      </table>
              </div>
              </div>
              </div>

<!-- Schedule Modal -->
<div id="scheduleModal" class="modal-overlay" style="display: none;">
  <div class="modal-container" style="max-width: 90vw; width: 1200px;">
    <div class="modal-header">
      <h3>Flight Schedule</h3>
      <button class="modal-close" id="closeScheduleModalBtn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body" style="padding: 1.5rem;">
      <div style="margin-bottom: 1rem;">
        <button class="btn btn-sm btn-secondary" id="copyScheduleBtn" style="margin-bottom: 1rem;">
          <i class="bi bi-clipboard"></i>
          Copy to clipboard
        </button>
      </div>
      <textarea id="scheduleText" readonly style="width: 100%; min-height: 300px; padding: 1rem; border: 1px solid hsl(210, 11%, 90%); border-radius: 0.5rem; font-family: monospace; font-size: 0.875rem; resize: vertical; background-color: hsl(210, 11%, 98%); white-space: nowrap; overflow-x: auto;"></textarea>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-cancel" id="closeScheduleBtn">
        Close
      </button>
    </div>
  </div>
</div>

<!-- Change Status Modal -->
<div id="changeStatusModal" class="modal-overlay" style="display: none;">
  <div class="modal-container" style="max-width: 400px;">
    <div class="modal-header">
      <h3>Change Flight Status</h3>
      <button class="modal-close" id="closeStatusModalBtn">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body" style="padding: 1.5rem;">
      <div class="form-group">
        <label for="statusSelect">Select Status</label>
        <select id="statusSelect" class="form-select" style="width: 100%; padding: 0.75rem; border: 1px solid hsl(210, 11%, 90%); border-radius: 0.5rem; font-size: 0.875rem; background-color: white;">
          <option value="Planned">Planned</option>
          <option value="Completed">Completed</option>
          <option value="Invoiced">Invoiced</option>
          <option value="Cancelled">Cancelled</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn btn-cancel" id="cancelStatusBtn">
        Cancel
      </button>
      <button type="button" class="btn btn-save" id="saveStatusBtn">
        <span class="btn-text">Save</span>
        <span class="btn-spinner" style="display: none;">
          <i class="bi bi-arrow-clockwise"></i>
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Add Flight Modal -->
<div id="addFlightModal" class="modal-overlay" style="display: none;">
  <div class="modal-container">
    <div class="modal-header">
      <h3>Add New Flight</h3>
      <button class="modal-close" id="closeModalBtn">
        <i class="bi bi-x-lg"></i>
                </button>
              </div>
    
    <form id="addFlightForm" class="modal-form">
      <div style="flex: 1; min-height: 0;">
        <div class="form-group">
          <label for="flightDate">Date</label>
          <input type="date" id="flightDate" name="flt_date" required>
              </div>
        
        <div class="form-group">
          <label for="flightNumber">Flight Number</label>
          <input type="text" id="flightNumber" name="flt_number" placeholder="e.g., F9105" required>
              </div>
        
        <div class="form-group">
          <label for="departure">Departure</label>
          <input type="text" id="departure" name="flt_dep" placeholder="e.g., Abu Dhabi" required>
              </div>
        
        <div class="form-group">
          <label for="arrival">Arrival</label>
          <input type="text" id="arrival" name="flt_arr" placeholder="e.g., Dubai" required>
              </div>
        
        <div class="form-group">
          <label for="flightTime">Flight Time</label>
          <input type="text" id="flightTime" name="flt_time" placeholder="e.g., 0130 (01:30)" maxlength="4" pattern="[0-9]{4}" required>
          <small class="form-help">Enter 4 digits (e.g., 0130 for 01:30)</small>
              </div>
        
        <div class="form-group">
          <label for="blockTime">Block Time</label>
          <input type="text" id="blockTime" name="flt_block" placeholder="e.g., 0215 (02:15)" maxlength="4" pattern="[0-9]{4}" required>
          <small class="form-help">Enter 4 digits (e.g., 0215 for 02:15)</small>
              </div>
        
        <div class="form-group">
          <label for="flightComments">Comments</label>
          <textarea id="flightComments" name="flt_comments" rows="3" placeholder="Enter comments (optional)"></textarea>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-cancel" id="cancelBtn">
          Cancel
                </button>
        <button type="submit" class="btn btn-save" id="saveFlightBtn">
          <span class="btn-text">Save</span>
          <span class="btn-spinner" style="display: none;">
            <i class="bi bi-arrow-clockwise"></i>
          </span>
                </button>
              </div>
    </form>
              </div>
              </div>

<script>
let flightsData = [];
let currentSortOrder = 'desc';

// Load statistics
async function loadStats() {
  try {
    const response = await fetch('/api/dashboard/stats', {
      credentials: 'include'
    });
    
    if (response.ok) {
      const stats = await response.json();
      
      // Update Completed Flights
      const completedFlightsEl = document.getElementById('completed-flights-value');
      if (completedFlightsEl) {
        completedFlightsEl.textContent = stats.completed_flights_this_year || 0;
      }

      // Update Completed Flights badge with percentage
      const completedFlightsBadge = document.getElementById('completed-flights-badge');
      const completedFlightsPercent = document.getElementById('completed-flights-percent');
      const completedFlightsArrow = document.getElementById('completed-flights-arrow');
      
      if (completedFlightsBadge && completedFlightsPercent && completedFlightsArrow) {
        const changePercent = stats.completed_flights_change_percent || 0;
        
        if (changePercent !== 0 || stats.completed_flights_last_year > 0) {
          const isIncrease = changePercent > 0;
          const sign = isIncrease ? '+' : '';
          const percentValue = Math.abs(changePercent).toFixed(0);
          
          completedFlightsPercent.textContent = `${sign}${percentValue}%`;
          
          // Set badge color and arrow
          if (isIncrease) {
            completedFlightsBadge.className = 'metric-badge metric-badge-positive';
            completedFlightsArrow.className = 'bi bi-arrow-up';
          } else if (changePercent < 0) {
            completedFlightsBadge.className = 'metric-badge metric-badge-negative';
            completedFlightsArrow.className = 'bi bi-arrow-down';
          } else {
            completedFlightsBadge.className = 'metric-badge metric-badge-neutral';
            completedFlightsArrow.className = '';
          }
          
          completedFlightsBadge.style.display = 'flex';
        } else {
          completedFlightsBadge.style.display = 'none';
        }
      }
      
      // Update Processed Invoices
      const processedInvoicesEl = document.getElementById('processed-invoices-value');
      if (processedInvoicesEl) {
        processedInvoicesEl.textContent = stats.processed_invoices_this_year || 0;
      }

      // Update Discrepancies
      const discrepanciesOpenEl = document.getElementById('discrepancies-open-value');
      if (discrepanciesOpenEl) {
        discrepanciesOpenEl.textContent = stats.discrepancies_open || 0;
      }

      const discrepanciesTotalEl = document.getElementById('discrepancies-total-value');
      if (discrepanciesTotalEl) {
        discrepanciesTotalEl.textContent = stats.discrepancies_total || 0;
      }
    }
  } catch (error) {
    console.error('Error loading stats:', error);
  }
}

// Check if flight has expenses for specific categories
function checkExpenseCategories(flight) {
  const expenses = flight.expenses || [];
  const expenseTypes = expenses.map(e => (e.exp_type || '').toLowerCase());
  
  return {
    hasGH: expenseTypes.some(type => type.includes('ground handling') || type.includes('groundhandling')),
    hasFuel: expenseTypes.some(type => type.includes('fuel')),
    hasCAT: expenseTypes.some(type => type.includes('catering') || type.includes('food'))
  };
}

// Render expense status bar
function renderExpenseBar(flight) {
  const categories = checkExpenseCategories(flight);
  
  return `
    <div class="expense-bar-container">
      <div class="expense-bar">
        <div class="expense-bar-section ${categories.hasGH ? 'filled' : 'empty'}" title="Ground Handling">
          <span class="expense-bar-label">GH</span>
        </div>
        <div class="expense-bar-section ${categories.hasFuel ? 'filled' : 'empty'}" title="Fuel">
          <span class="expense-bar-label">F</span>
        </div>
        <div class="expense-bar-section ${categories.hasCAT ? 'filled' : 'empty'}" title="Catering">
          <span class="expense-bar-label">CAT</span>
        </div>
      </div>
    </div>
  `;
}

// Load flights data from API
async function loadFlights() {
  try {
    const response = await apiRequest('/api/flights');
    console.log('Flights API response status:', response.status);
    const flights = await response.json();
    console.log('Flights API response data:', flights);
    
    // Check if flights is an array
    if (!Array.isArray(flights)) {
      console.error('Flights data is not an array:', flights);
      throw new Error('Invalid flights data format');
    }
    
    flightsData = flights;
    renderFlights();
    
    // Update stats after loading flights
    await loadStats();
  } catch (error) {
    console.error('Error loading flights:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    
    // Show error message
    const tbody = document.getElementById('flights-table-body');
    tbody.innerHTML = `
      <tr>
        <td colspan="11" style="text-align: center; padding: 2rem; color: #6b7280;">
          <i class="bi bi-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
          Failed to load flights. Please try again.
          <br><small style="color: #9ca3af; margin-top: 0.5rem; display: block;">Error: ${error.message}</small>
        </td>
      </tr>
    `;
  }
}

function renderFlights() {
  const tbody = document.getElementById('flights-table-body');

  if (!tbody) {
    return;
  }

  tbody.innerHTML = '';

  if (!Array.isArray(flightsData) || flightsData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="11" style="text-align: center; padding: 2rem; color: #6b7280;">
          <i class="bi bi-info-circle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
          No flights available.
        </td>
      </tr>
    `;
    return;
  }

  const sortedFlights = [...flightsData].sort((a, b) => {
    const dateA = new Date(a.flt_date).getTime();
    const dateB = new Date(b.flt_date).getTime();

    return currentSortOrder === 'asc' ? dateA - dateB : dateB - dateA;
  });

  const monthGroups = [];
  let currentGroupKey = null;
  let currentGroup = null;

  sortedFlights.forEach(flight => {
    const date = new Date(flight.flt_date);
    const monthKey = `${date.getFullYear()}-${date.getMonth().toString().padStart(2, '0')}`;

    if (!currentGroup || currentGroupKey !== monthKey) {
      currentGroupKey = monthKey;
      currentGroup = {
        label: date.toLocaleDateString('en-US', {
          month: 'long',
          year: 'numeric'
        }),
        flights: []
      };
      monthGroups.push(currentGroup);
    }

    currentGroup.flights.push(flight);
  });

  monthGroups.forEach(group => {
    const monthRow = document.createElement('tr');
    monthRow.innerHTML = `
      <td colspan="11" class="month-separator">
        <div class="month-divider">
          <span class="month-label">${group.label}</span>
        </div>
      </td>
    `;
    tbody.appendChild(monthRow);

    const getCreatedTimestamp = flight => {
      const raw = flight.created_at || flight.inserted_at || flight.flt_created_at || flight.flt_updated_at || flight.flt_date;
      const timestamp = raw ? new Date(raw).getTime() : 0;
      return Number.isFinite(timestamp) ? timestamp : 0;
    };

    group.flights
      .slice()
      .sort((a, b) => getCreatedTimestamp(b) - getCreatedTimestamp(a))
      .forEach(flight => {
      const row = document.createElement('tr');

      const date = new Date(flight.flt_date);
      const formattedDate = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      const route = `${flight.flt_dep} - ${flight.flt_arr}`;

      const formatTime = timeString => {
        if (!timeString) {
          return '00:00';
        }

        // Check if time string contains a colon (handles HH:MM or HH:MM:SS)
        if (timeString.includes(':')) {
          const parts = timeString.split(':');
          if (parts.length >= 2) {
            const [hours, minutes] = parts;
            return `${hours}:${minutes}`;
          }
        }
        
        // Handle time string without colon (e.g., "0100" -> "01:00")
        const digitsOnly = timeString.replace(/\D/g, '');
        if (digitsOnly.length === 4) {
          const hours = digitsOnly.substring(0, 2);
          const minutes = digitsOnly.substring(2, 4);
          return `${hours}:${minutes}`;
        }
        
        // Fallback for invalid formats
        return '00:00';
      };

      // Store flight data in the row for easy access (before setting innerHTML)
      row.setAttribute('data-flight-id', flight.id || '');
      try {
        row.setAttribute('data-flight-data', JSON.stringify(flight));
      } catch (e) {
        console.error('Error stringifying flight data:', e);
      }

      row.innerHTML = `
        <td class="checkbox-col">
          <input type="checkbox" class="form-check-input flight-checkbox" data-flight-id="${flight.id}">
        </td>
        <td>
          <div class="date-badge">${formattedDate}</div>
        </td>
        <td>
          <div class="flight-number">${flight.flt_number}</div>
        </td>
        <td>
          <div class="route-info">
            <div class="route-main">${route}</div>
          </div>
        </td>
        <td>
          <div class="time-info">
            <div class="time-main">${formatTime(flight.flt_time)}</div>
          </div>
        </td>
        <td>
          <div class="time-info">
            <div class="time-main">${formatTime(flight.flt_block)}</div>
          </div>
        </td>
        <td>
          <div class="status-cell">
            <span class="status-badge status-${(flight.flt_status || 'Completed').toLowerCase()}" data-flight-id="${flight.id}" data-current-status="${flight.flt_status || 'Completed'}" style="cursor: pointer;">
              ${flight.flt_status || 'Completed'}
            </span>
          </div>
        </td>
        <td>
          <div class="expense-bar-clickable" data-flight-number="${flight.flt_number}" style="cursor: pointer;">
            ${renderExpenseBar(flight)}
          </div>
        </td>
        <td>
          <div class="comments-info">
            <div class="comments-main ${!flight.flt_comments ? 'comments-empty' : ''}">${flight.flt_comments || 'n/a'}</div>
          </div>
        </td>
        <td>
          <div class="action-buttons">
            <% if (user && user.role === 'superadmin') { %>
            <button class="btn-action" title="Delete" data-action="delete" data-id="${flight.id}">
              <i class="bi bi-trash"></i>
            </button>
            <% } else { %>
            <span class="text-muted" style="font-size: 0.75rem;">Read Only</span>
            <% } %>
          </div>
        </td>
      `;

      // Make expense bar clickable
      const expenseBarClickable = row.querySelector('.expense-bar-clickable');
      if (expenseBarClickable) {
        expenseBarClickable.addEventListener('click', function(e) {
          e.stopPropagation();
          const flightNumber = this.getAttribute('data-flight-number');
          viewFlight(flightNumber);
        });
      }

      // Make status badge clickable
      const statusBadge = row.querySelector('.status-badge');
      if (statusBadge) {
        statusBadge.addEventListener('click', function(e) {
          e.stopPropagation();
          const flightId = this.getAttribute('data-flight-id');
          const currentStatus = this.getAttribute('data-current-status');
          openStatusModal(flightId, currentStatus);
        });
      }

      const actionButtons = row.querySelectorAll('.btn-action');
      actionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
          e.stopPropagation();
          const action = this.getAttribute('data-action');
          const id = this.getAttribute('data-id');

          if (action === 'delete') {
            deleteFlight(id);
          }
        });
      });

      tbody.appendChild(row);
      });
  });

  updateSortIcon();
  
  // Setup checkbox handlers
  setupCheckboxHandlers();
}

// Setup checkbox selection handlers
let selectAllHandlerSetup = false;

function setupCheckboxHandlers() {
  const selectAllCheckbox = document.getElementById('selectAll');
  const flightCheckboxes = document.querySelectorAll('.flight-checkbox');
  
  // Select all functionality - only set up once
  if (selectAllCheckbox && !selectAllHandlerSetup) {
    selectAllCheckbox.addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.flight-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });
    selectAllHandlerSetup = true;
  }
  
  // Use event delegation on tbody for individual checkboxes
  const tbody = document.getElementById('flights-table-body');
  if (tbody) {
    // Remove old listener if exists and add new one
    tbody.removeEventListener('change', handleCheckboxChange);
    tbody.addEventListener('change', handleCheckboxChange);
  }
}

function handleCheckboxChange(e) {
  if (e.target.classList.contains('flight-checkbox')) {
    const selectAllCheckbox = document.getElementById('selectAll');
    const allCheckboxes = document.querySelectorAll('.flight-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
    const someChecked = Array.from(allCheckboxes).some(cb => cb.checked);
    if (selectAllCheckbox) {
      selectAllCheckbox.checked = allChecked;
      selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }
  }
}

// Get schedule for selected flights
function getSchedule() {
  const checkedBoxes = document.querySelectorAll('.flight-checkbox:checked');
  
  if (checkedBoxes.length === 0) {
    alert('Please select at least one flight.');
    return;
  }
  
  console.log('Checked boxes:', checkedBoxes.length);
  console.log('Flights data:', flightsData.length);
  
  // Get selected flights - use row data for more reliable access
  const selectedFlights = [];
  
  checkedBoxes.forEach(checkbox => {
    // Find the parent row
    const row = checkbox.closest('tr');
    if (row) {
      const flightDataStr = row.getAttribute('data-flight-data');
      if (flightDataStr) {
        try {
          const flightData = JSON.parse(flightDataStr);
          selectedFlights.push(flightData);
        } catch (e) {
          console.error('Error parsing flight data:', e);
          // Fallback: try to find by ID
          const flightId = checkbox.getAttribute('data-flight-id');
          const flight = flightsData.find(f => String(f.id) === String(flightId));
          if (flight) {
            selectedFlights.push(flight);
          }
        }
      } else {
        // Fallback: find by ID
        const flightId = checkbox.getAttribute('data-flight-id');
        const flight = flightsData.find(f => String(f.id) === String(flightId));
        if (flight) {
          selectedFlights.push(flight);
        }
      }
    }
  });
  
  console.log('Selected flights:', selectedFlights);
  
  if (selectedFlights.length === 0) {
    alert('No flights found for selected items. Please try again.');
    console.error('No flights matched. Flight IDs in data:', flightsData.map(f => f.id));
    return;
  }
  
  // Sort by date
  selectedFlights.sort((a, b) => {
    const dateA = new Date(a.flt_date).getTime();
    const dateB = new Date(b.flt_date).getTime();
    return dateA - dateB;
  });
  
  // Format time helper function
  const formatTime = timeString => {
    if (!timeString) {
      return '00:00';
    }
    
    // Check if time string contains a colon (handles HH:MM or HH:MM:SS)
    if (timeString.includes(':')) {
      const parts = timeString.split(':');
      if (parts.length >= 2) {
        const [hours, minutes] = parts;
        return `${hours}:${minutes}`;
      }
    }
    
    // Handle time string without colon (e.g., "0100" -> "01:00")
    const digitsOnly = timeString.replace(/\D/g, '');
    if (digitsOnly.length === 4) {
      const hours = digitsOnly.substring(0, 2);
      const minutes = digitsOnly.substring(2, 4);
      return `${hours}:${minutes}`;
    }
    
    // Fallback for invalid formats
    return '00:00';
  };

  // Format schedule text
  const scheduleLines = selectedFlights.map(flight => {
    const date = new Date(flight.flt_date);
    const day = String(date.getDate()).padStart(2, '0');
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const month = monthNames[date.getMonth()];
    const year = date.getFullYear();
    const formattedDate = `${day}-${month}-${year}`;
    
    const route = `${flight.flt_dep || ''} - ${flight.flt_arr || ''}`;
    const flightTime = formatTime(flight.flt_time);
    const blockTime = formatTime(flight.flt_block);
    return `${formattedDate} ${flight.flt_number || ''} ${route} ${flightTime}/${blockTime}`;
  });
  
  const scheduleText = '(date, flight number, route, flight time/block time)\n' + scheduleLines.join('\n');
  
  console.log('Schedule text:', scheduleText);
  
  // Display in modal - set text first, then show modal
  const scheduleTextArea = document.getElementById('scheduleText');
  const scheduleModal = document.getElementById('scheduleModal');
  
  if (!scheduleTextArea) {
    console.error('Schedule textarea not found!');
    alert('Error: Schedule textarea not found');
    return;
  }
  
  if (!scheduleModal) {
    console.error('Schedule modal not found!');
    alert('Error: Schedule modal not found');
    return;
  }
  
  // Set text first
  scheduleTextArea.value = scheduleText;
  console.log('Text set in textarea:', scheduleTextArea.value);
  console.log('Textarea value length:', scheduleTextArea.value.length);
  
  // Then show modal - use setTimeout to ensure text is set first
  setTimeout(() => {
    scheduleModal.classList.add('show');
    scheduleModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    console.log('Modal shown');
  }, 10);
}

// Close schedule modal
function closeScheduleModal() {
  const scheduleModal = document.getElementById('scheduleModal');
  if (scheduleModal) {
    scheduleModal.classList.remove('show');
    document.body.style.overflow = 'auto';
  }
}

// Copy schedule to clipboard
function copyScheduleToClipboard() {
  const scheduleTextArea = document.getElementById('scheduleText');
  if (scheduleTextArea) {
    scheduleTextArea.select();
    scheduleTextArea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
      document.execCommand('copy');
      const copyBtn = document.getElementById('copyScheduleBtn');
      if (copyBtn) {
        const originalText = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="bi bi-check"></i> Copied!';
        copyBtn.style.backgroundColor = 'hsl(142, 76%, 36%)';
        setTimeout(() => {
          copyBtn.innerHTML = originalText;
          copyBtn.style.backgroundColor = '';
        }, 2000);
      }
    } catch (err) {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard. Please select and copy manually.');
    }
  }
}

function updateSortIcon() {
  const sortIcon = document.getElementById('dateSortIcon');

  if (!sortIcon) {
    return;
  }

  sortIcon.classList.remove('bi-chevron-up', 'bi-chevron-down');

  if (currentSortOrder === 'asc') {
    sortIcon.classList.add('bi-chevron-down');
  } else {
    sortIcon.classList.add('bi-chevron-up');
  }
}

// Action functions
function viewFlight(flightNumber) {
  // Encode flight number for URL (handle special characters)
  const encodedFlightNumber = encodeURIComponent(flightNumber);
  window.location.href = `/flights/${encodedFlightNumber}/expenses`;
}

function editFlight(id) {
  console.log('Edit flight:', id);
  // TODO: Implement edit functionality
}

async function deleteFlight(id) {
  // Show confirmation dialog
  const confirmed = confirm('Are you sure you want to delete this flight? This action cannot be undone.');
  
  if (!confirmed) {
    return;
  }
  
  try {
    const response = await apiRequest(`/api/flights/${id}`, {
      method: 'DELETE',
    });
    
    if (response.ok) {
      // Reload flights after successful deletion
      await loadFlights();
      console.log('Flight deleted successfully');
    } else {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to delete flight');
    }
  } catch (error) {
    console.error('Error deleting flight:', error);
    alert('Failed to delete flight: ' + error.message);
  }
}

// Status modal functions
let currentStatusFlightId = null;

function openStatusModal(flightId, currentStatus) {
  currentStatusFlightId = flightId;
  const modal = document.getElementById('changeStatusModal');
  const statusSelect = document.getElementById('statusSelect');
  
  if (modal && statusSelect) {
    // Set current status
    statusSelect.value = currentStatus || 'Completed';
    
    // Show modal
    modal.classList.add('show');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeStatusModal() {
  const modal = document.getElementById('changeStatusModal');
  if (modal) {
    modal.classList.remove('show');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
    currentStatusFlightId = null;
  }
}

async function saveStatusChange() {
  if (!currentStatusFlightId) {
    return;
  }
  
  const statusSelect = document.getElementById('statusSelect');
  const saveBtn = document.getElementById('saveStatusBtn');
  const btnText = saveBtn.querySelector('.btn-text');
  const btnSpinner = saveBtn.querySelector('.btn-spinner');
  
  if (!statusSelect) {
    return;
  }
  
  const newStatus = statusSelect.value;
  
  // Show spinner
  btnText.style.display = 'none';
  btnSpinner.style.display = 'inline-block';
  saveBtn.disabled = true;
  
  try {
    const response = await apiRequest(`/api/flights/${currentStatusFlightId}/status`, {
      method: 'PATCH',
      body: JSON.stringify({ flt_status: newStatus })
    });
    
    if (response.ok) {
      // Close modal and reload flights
      closeStatusModal();
      await loadFlights();
      console.log('Flight status updated successfully');
    } else {
      const errorData = await response.json();
      throw new Error(errorData.error || 'Failed to update flight status');
    }
  } catch (error) {
    console.error('Error updating flight status:', error);
    alert('Failed to update flight status: ' + error.message);
  } finally {
    // Hide spinner
    btnText.style.display = 'inline-block';
    btnSpinner.style.display = 'none';
    saveBtn.disabled = false;
  }
}

// Load data when page loads
// Modal functions
function openAddFlightModal() {
  console.log('openAddFlightModal called');
  const modal = document.getElementById('addFlightModal');
  console.log('Modal element:', modal);
  
  if (modal) {
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    console.log('Modal should be visible now');
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('flightDate');
    if (dateInput) {
      dateInput.value = today;
    }
  } else {
    console.error('Modal element not found!');
  }
}

function closeAddFlightModal() {
  const modal = document.getElementById('addFlightModal');
  modal.classList.remove('show');
  document.body.style.overflow = 'auto';
  
  // Reset form
  document.getElementById('addFlightForm').reset();
}

// Time validation and formatting functions
function formatTimeInput(input) {
  let value = input.value.replace(/\D/g, ''); // Remove non-digits
  
  // Limit to 4 digits
  if (value.length > 4) {
    value = value.substring(0, 4);
  }
  
  input.value = value;
  
  // Auto-format to HH:MM when 4 digits are entered
  if (value.length === 4) {
    const hours = value.substring(0, 2);
    const minutes = value.substring(2, 4);
    
    // Validate hours (00-23)
    if (parseInt(hours) > 23) {
      input.setCustomValidity('Hours must be between 00 and 23');
      return false;
    }
    
    // Validate minutes (00-59)
    if (parseInt(minutes) > 59) {
      input.setCustomValidity('Minutes must be between 00 and 59');
      return false;
    }
    
    input.setCustomValidity(''); // Clear any previous validation errors
    return true;
  }
  
  input.setCustomValidity(''); // Clear validation errors
  return true;
}

function validateTimeInput(input) {
  const value = input.value;
  
  if (value.length === 4) {
    const hours = parseInt(value.substring(0, 2));
    const minutes = parseInt(value.substring(2, 4));
    
    if (hours > 23) {
      input.setCustomValidity('Hours must be between 00 and 23');
      return false;
    }
    
    if (minutes > 59) {
      input.setCustomValidity('Minutes must be between 00 and 59');
      return false;
    }
  }
  
  input.setCustomValidity('');
  return true;
}

document.addEventListener('DOMContentLoaded', function() {
  // Load statistics
  loadStats();
  // Load flights data
  loadFlights();
  
  // Test if modal functions are available
  console.log('DOM loaded, testing modal functions...');
  console.log('openAddFlightModal function:', typeof openAddFlightModal);
  console.log('closeAddFlightModal function:', typeof closeAddFlightModal);
  
  // Add event listeners for modal buttons
  const addFlightBtn = document.getElementById('addFlightBtn');
  if (addFlightBtn) {
    addFlightBtn.addEventListener('click', openAddFlightModal);
    console.log('Add Flight button event listener added');
  }
  
  const dateSortHeader = document.getElementById('dateSortHeader');
  if (dateSortHeader) {
    dateSortHeader.addEventListener('click', () => {
      currentSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
      renderFlights();
    });
  }
  
  const closeModalBtn = document.getElementById('closeModalBtn');
  if (closeModalBtn) {
    closeModalBtn.addEventListener('click', closeAddFlightModal);
    console.log('Close Modal button event listener added');
  }
  
  const cancelBtn = document.getElementById('cancelBtn');
  if (cancelBtn) {
    cancelBtn.addEventListener('click', closeAddFlightModal);
    console.log('Cancel button event listener added');
  }
  
  // Handle form submission
  const addFlightForm = document.getElementById('addFlightForm');
  if (addFlightForm) {
    addFlightForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const saveBtn = document.getElementById('saveFlightBtn');
      const btnText = saveBtn.querySelector('.btn-text');
      const btnSpinner = saveBtn.querySelector('.btn-spinner');
      
      // Show spinner
      btnText.style.display = 'none';
      btnSpinner.style.display = 'inline-block';
      saveBtn.disabled = true;
      
      try {
        const formData = new FormData(this);
        const flightData = Object.fromEntries(formData.entries());
        
        // Convert 4-digit time format to HH:MM:SS for database
        if (flightData.flt_time && flightData.flt_time.length === 4) {
          const hours = flightData.flt_time.substring(0, 2);
          const minutes = flightData.flt_time.substring(2, 4);
          flightData.flt_time = `${hours}:${minutes}:00`;
        }
        
        if (flightData.flt_block && flightData.flt_block.length === 4) {
          const hours = flightData.flt_block.substring(0, 2);
          const minutes = flightData.flt_block.substring(2, 4);
          flightData.flt_block = `${hours}:${minutes}:00`;
        }
        
        const response = await apiRequest('/api/flights', {
          method: 'POST',
          body: JSON.stringify(flightData)
        });
        
        if (response.ok) {
          // Close modal and reload flights
          closeAddFlightModal();
          await loadFlights();
          
          // Show success message (optional)
          console.log('Flight added successfully');
        } else {
          throw new Error('Failed to add flight');
        }
      } catch (error) {
        console.error('Error adding flight:', error);
        alert('Failed to add flight. Please try again.');
      } finally {
        // Hide spinner
        btnText.style.display = 'inline-block';
        btnSpinner.style.display = 'none';
        saveBtn.disabled = false;
      }
    });
  }
  
  // Close modal when clicking outside
  const addFlightModal = document.getElementById('addFlightModal');
  if (addFlightModal) {
    addFlightModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeAddFlightModal();
      }
    });
  }
  
  // Get schedule button
  const getScheduleBtn = document.getElementById('getScheduleBtn');
  if (getScheduleBtn) {
    getScheduleBtn.addEventListener('click', getSchedule);
  }
  
  // Schedule modal handlers
  const closeScheduleModalBtn = document.getElementById('closeScheduleModalBtn');
  if (closeScheduleModalBtn) {
    closeScheduleModalBtn.addEventListener('click', closeScheduleModal);
  }
  
  const closeScheduleBtn = document.getElementById('closeScheduleBtn');
  if (closeScheduleBtn) {
    closeScheduleBtn.addEventListener('click', closeScheduleModal);
  }
  
  const copyScheduleBtn = document.getElementById('copyScheduleBtn');
  if (copyScheduleBtn) {
    copyScheduleBtn.addEventListener('click', copyScheduleToClipboard);
  }
  
  const scheduleModal = document.getElementById('scheduleModal');
  if (scheduleModal) {
    scheduleModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeScheduleModal();
      }
    });
  }
  
  // Status modal handlers
  const closeStatusModalBtn = document.getElementById('closeStatusModalBtn');
  if (closeStatusModalBtn) {
    closeStatusModalBtn.addEventListener('click', closeStatusModal);
  }
  
  const cancelStatusBtn = document.getElementById('cancelStatusBtn');
  if (cancelStatusBtn) {
    cancelStatusBtn.addEventListener('click', closeStatusModal);
  }
  
  const saveStatusBtn = document.getElementById('saveStatusBtn');
  if (saveStatusBtn) {
    saveStatusBtn.addEventListener('click', saveStatusChange);
  }
  
  const changeStatusModal = document.getElementById('changeStatusModal');
  if (changeStatusModal) {
    changeStatusModal.addEventListener('click', function(e) {
      if (e.target === this) {
        closeStatusModal();
      }
    });
  }
  
  // Add time input validation and formatting
  const flightTimeInput = document.getElementById('flightTime');
  const blockTimeInput = document.getElementById('blockTime');
  
  if (flightTimeInput) {
    flightTimeInput.addEventListener('input', function() {
      formatTimeInput(this);
    });
    
    flightTimeInput.addEventListener('blur', function() {
      validateTimeInput(this);
    });
    
    // Prevent non-numeric input
    flightTimeInput.addEventListener('keypress', function(e) {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
        e.preventDefault();
      }
    });
  }
  
  if (blockTimeInput) {
    blockTimeInput.addEventListener('input', function() {
      formatTimeInput(this);
    });
    
    blockTimeInput.addEventListener('blur', function() {
      validateTimeInput(this);
    });
    
    // Prevent non-numeric input
    blockTimeInput.addEventListener('keypress', function(e) {
      if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
        e.preventDefault();
      }
    });
  }
});
</script>

<style>
/* Modal styles */
.modal-overlay {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100% !important;
  height: 100% !important;
  background-color: rgba(0, 0, 0, 0.5) !important;
  display: none !important;
  justify-content: center !important;
  align-items: center !important;
  z-index: 10000 !important;
}

.modal-overlay.show {
  display: flex !important;
}

.modal-container {
  background: white !important;
  border-radius: 0.75rem !important;
  box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
  width: 90% !important;
  max-width: 500px !important;
  overflow-y: visible !important;
  display: flex !important;
  flex-direction: column !important;
  max-height: 95vh !important;
}

.modal-header {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  padding: 1rem 1.5rem 0 1.5rem !important;
  border-bottom: 1px solid hsl(210, 11%, 90%) !important;
  margin-bottom: 1rem !important;
}

.modal-header h3 {
  margin: 0 !important;
  font-size: 1.25rem !important;
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-close {
  background: none !important;
  border: none !important;
  font-size: 1.25rem !important;
  color: hsl(210, 6%, 46%) !important;
  cursor: pointer !important;
  padding: 0.25rem !important;
  border-radius: 0.25rem !important;
  transition: all 0.2s ease !important;
}

.modal-close:hover {
  background-color: hsl(210, 11%, 95%) !important;
  color: hsl(210, 6%, 21%) !important;
}

.modal-form {
  padding: 0 1.5rem 0.5rem 1.5rem !important;
  display: flex !important;
  flex-direction: column !important;
  flex: 1 !important;
  min-height: 0 !important;
  overflow: hidden !important;
}

.form-group {
  margin-bottom: 0.875rem !important;
}

.form-group label {
  display: block !important;
  margin-bottom: 0.375rem !important;
  font-weight: 500 !important;
  color: hsl(210, 6%, 21%) !important;
  font-size: 0.875rem !important;
}

.form-group input,
.form-group textarea {
  width: 100% !important;
  padding: 0.75rem !important;
  border: 1px solid hsl(210, 11%, 90%) !important;
  border-radius: 0.5rem !important;
  font-size: 0.875rem !important;
  transition: all 0.2s ease !important;
  background-color: white !important;
  font-family: inherit !important;
  box-sizing: border-box !important;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none !important;
  border-color: hsl(142, 76%, 36%) !important;
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
}

.form-group textarea {
  resize: vertical !important;
  min-height: 80px !important;
}

.form-group input::placeholder,
.form-group textarea::placeholder {
  color: hsl(210, 6%, 60%) !important;
}

.form-help {
  display: block !important;
  margin-top: 0.25rem !important;
  font-size: 0.75rem !important;
  color: hsl(210, 6%, 60%) !important;
  font-style: italic !important;
}

.form-group input:invalid {
  border-color: hsl(0, 84%, 60%) !important;
  box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.form-group input:valid {
  border-color: hsl(142, 76%, 36%) !important;
}

.modal-actions {
  display: flex !important;
  justify-content: flex-end !important;
  gap: 0.75rem !important;
  margin-top: 0 !important;
  padding: 1rem 1.5rem !important;
  border-top: 1px solid hsl(210, 11%, 90%) !important;
  flex-shrink: 0 !important;
}

.btn {
  padding: 0.75rem 1.5rem !important;
  border-radius: 0.5rem !important;
  font-weight: 500 !important;
  font-size: 0.875rem !important;
  border: none !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  display: inline-flex !important;
  align-items: center !important;
  gap: 0.5rem !important;
}

.btn:disabled {
  opacity: 0.6 !important;
  cursor: not-allowed !important;
}

.btn-cancel {
  background-color: hsl(0, 84%, 60%) !important;
  color: white !important;
}

.btn-cancel:hover:not(:disabled) {
  background-color: hsl(0, 84%, 55%) !important;
}

.btn-save {
  background-color: hsl(142, 76%, 36%) !important;
  color: white !important;
}

.btn-save:hover:not(:disabled) {
  background-color: hsl(142, 76%, 32%) !important;
}

.btn-spinner {
  animation: spin 1s linear infinite !important;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Month separator styles */
.month-separator {
  background-color: transparent !important;
  border: none !important;
  padding: 0 !important;
  height: 1px !important;
}

.month-divider {
  position: relative !important;
  height: 1px !important;
  background-color: hsl(210, 11%, 85%) !important;
  margin: 1rem 0 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: flex-start !important;
}

.month-label {
  background-color: white !important;
  color: hsl(210, 6%, 46%) !important;
  font-size: 0.75rem !important;
  font-weight: 500 !important;
  padding: 0.25rem 0.75rem !important;
  border-radius: 0.375rem !important;
  border: 1px solid hsl(210, 11%, 85%) !important;
  text-transform: uppercase !important;
  letter-spacing: 0.05em !important;
}

/* Responsive design */
@media (max-width: 640px) {
  .modal-container {
    width: 95% !important;
    margin: 1rem !important;
  }
  
  .modal-header {
    padding: 0.75rem 1rem 0 1rem !important;
    margin-bottom: 0.75rem !important;
  }
  
  .modal-form {
    padding: 0 1rem 0.5rem 1rem !important;
  }
  
  .modal-actions {
    flex-direction: column !important;
  }
  
  .btn {
    width: 100% !important;
    justify-content: center !important;
  }
}

/* Comments column styles */
.comments-info {
  display: flex !important;
  flex-direction: column !important;
}

.comments-main {
  font-weight: normal !important;
  font-style: italic !important;
  color: hsl(210, 6%, 60%) !important;
  margin-bottom: 0.125rem !important;
  word-wrap: break-word !important;
  max-width: 200px !important;
}

.comments-empty {
  font-weight: normal !important;
  font-style: italic !important;
  color: hsl(210, 6%, 60%) !important;
}

/* Light blue button styles */
.flights-action-btn {
  background-color: hsl(200, 75%, 60%) !important;
  border-color: hsl(200, 75%, 60%) !important;
  color: white !important;
}

.flights-action-btn:hover:not(:disabled) {
  background-color: hsl(200, 75%, 55%) !important;
  border-color: hsl(200, 75%, 55%) !important;
  color: white !important;
}

/* Status badge styles */
.status-cell {
  display: flex;
  align-items: center;
}

.status-badge {
  display: inline-block;
  padding: 0.375rem 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all 0.2s ease;
  user-select: none;
}

.status-badge:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.status-planned {
  background-color: #F5DF01;
  color: #1f2937;
}

.status-completed {
  background-color: #6DED80;
  color: #1f2937;
}

.status-invoiced {
  background-color: #6689BD;
  color: white;
}

.status-cancelled {
  background-color: #FF6439;
  color: white;
}

.form-select {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid hsl(210, 11%, 90%);
  border-radius: 0.5rem;
  font-size: 0.875rem;
  background-color: white;
  font-family: inherit;
  box-sizing: border-box;
  cursor: pointer;
}

.form-select:focus {
  outline: none;
  border-color: hsl(142, 76%, 36%);
  box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
}

/* Metric badges styles */
.finance-card-value-row {
  display: flex !important;
  justify-content: space-between !important;
  align-items: flex-end !important;
  gap: 0.5rem !important;
}

.metric-badge {
  display: flex !important;
  align-items: center !important;
  gap: 0.25rem !important;
  padding: 0.25rem 0.5rem !important;
  border-radius: 0.375rem !important;
  font-size: 0.75rem !important;
  font-weight: 500 !important;
  white-space: nowrap !important;
}

.metric-badge-positive {
  background-color: #d1fae5 !important;
  color: #065f46 !important;
}

.metric-badge-negative {
  background-color: #fee2e2 !important;
  color: #991b1b !important;
}

.metric-badge-neutral {
  background-color: #f3f4f6 !important;
  color: #6b7280 !important;
}

.metric-badge-text {
  font-size: 0.75rem !important;
  font-weight: 500 !important;
}

.metric-badge i {
  font-size: 0.625rem !important;
  line-height: 1 !important;
}

.metric-badge-secondary {
  display: flex !important;
  align-items: center !important;
  padding: 0.25rem 0.5rem !important;
  border-radius: 0.375rem !important;
  background-color: #f3f4f6 !important;
  color: #6b7280 !important;
  font-size: 0.75rem !important;
  font-weight: 500 !important;
  white-space: nowrap !important;
}

.metric-badge-text-secondary {
  font-size: 0.75rem !important;
  font-weight: 500 !important;
  color: #6b7280 !important;
}

/* Icon styles without background */
.finance-card-icon {
  background: transparent !important;
  width: auto !important;
  height: auto !important;
  border-radius: 0 !important;
  padding: 0 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: flex-start !important;
}

.finance-card-icon svg {
  width: 24px !important;
  height: 24px !important;
}

/* Expense bar styles */
.expense-bar-container {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.25rem 0;
}

.expense-bar {
  display: flex;
  width: 100%;
  max-width: 120px;
  height: 24px;
  border-radius: 0.375rem;
  overflow: hidden;
  border: 1px solid hsl(210, 11%, 85%);
  background-color: hsl(210, 11%, 95%);
}

.expense-bar-section {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  border-right: 1px solid hsl(210, 11%, 85%);
  transition: background-color 0.2s ease;
}

.expense-bar-section:last-child {
  border-right: none;
}

.expense-bar-section.filled {
  background-color: hsl(142, 76%, 36%);
}

.expense-bar-section.empty {
  background-color: hsl(210, 11%, 90%);
}

.expense-bar-label {
  font-size: 0.625rem;
  font-weight: 600;
  color: white;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  z-index: 1;
  position: relative;
}

.expense-bar-section.empty .expense-bar-label {
  color: hsl(210, 6%, 60%);
  text-shadow: none;
}

/* Clickable expense bar */
.expense-bar-clickable {
  display: inline-block;
  width: 100%;
  transition: opacity 0.2s ease;
}

.expense-bar-clickable:hover {
  opacity: 0.8;
}

.expense-bar-clickable .expense-bar-container {
  pointer-events: none;
}

/* Reduce height of metric cards */
#stats-cards .finance-card {
  padding: 1rem !important;
}

#stats-cards .finance-card-title {
  font-size: 0.75rem !important;
  margin-bottom: 0.125rem !important;
}

#stats-cards .finance-card-value {
  font-size: 1.25rem !important;
}

#stats-cards .finance-card-content {
  gap: 0.5rem !important;
}
</style>