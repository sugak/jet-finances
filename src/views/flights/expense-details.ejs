<!-- Page Header -->
<div class="page-header">
  <div>
    <h1 class="page-title" id="flight-title">Flight <%= flight.flt_number %> Expenses</h1>
    <p class="page-description" id="flight-info-description">
      Loading flight information...
    </p>
  </div>
  <div class="page-actions">
    <button class="btn btn-secondary" id="backBtn">
      <i class="bi bi-arrow-left"></i>
      Back to Flights
    </button>
  </div>
</div>

<!-- Loading Spinner -->
<div id="loading-spinner" class="loading-container">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="loading-text">Loading flight expenses...</p>
</div>

<!-- Content Container -->
<div id="content-container" class="content-container" style="display: none;">
  <div id="expenses-sections-container">
    <!-- Expense sections will be populated by JavaScript -->
  </div>
</div>

<!-- No Data Message -->
<div id="no-data-message" class="no-data-container" style="display: none;">
  <div class="text-center py-5">
    <i class="bi bi-receipt text-muted" style="font-size: 3rem;"></i>
    <h3 class="text-muted mt-3">No Expenses Found</h3>
    <p class="text-muted">This flight has no associated expenses.</p>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  loadFlightExpenses();
  
  // Back button handler
  document.getElementById('backBtn').addEventListener('click', function() {
    window.location.href = '/flights';
  });
});

async function loadFlightExpenses() {
  try {
    const flightNumber = '<%= flight.flt_number %>';
    const encodedFlightNumber = encodeURIComponent(flightNumber);
    const response = await apiRequest(`/api/flights/${encodedFlightNumber}/expenses`);
    const flightData = await response.json();
    
    // Hide loading spinner
    document.getElementById('loading-spinner').style.display = 'none';
    
    // Update flight info description with all flights
    updateFlightInfoDescription(flightData.flights || []);
    
    if (!flightData || !flightData.expenses || flightData.expenses.length === 0) {
      document.getElementById('no-data-message').style.display = 'block';
      return;
    }
    
    // Show content
    document.getElementById('content-container').style.display = 'block';
    
    // Group expenses by category
    const groupedExpenses = groupExpensesByCategory(flightData.expenses);
    
    // Render expense cards
    renderExpenseCards(groupedExpenses);
    
  } catch (error) {
    console.error('Error loading flight expenses:', error);
    document.getElementById('loading-spinner').style.display = 'none';
    document.getElementById('no-data-message').style.display = 'block';
  }
}

function updateFlightInfoDescription(flights) {
  const descriptionElement = document.getElementById('flight-info-description');
  
  if (!flights || flights.length === 0) {
    descriptionElement.textContent = 'No flight information available';
    return;
  }
  
  // Sort flights by date
  const sortedFlights = flights.sort((a, b) => {
    const dateA = new Date(a.flt_date);
    const dateB = new Date(b.flt_date);
    return dateA - dateB;
  });
  
  // Format flights info
  const flightInfoParts = sortedFlights.map(flight => {
    const date = new Date(flight.flt_date);
    const formattedDate = date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    const route = `${flight.flt_dep} → ${flight.flt_arr}`;
    return `${formattedDate} • ${route}`;
  });
  
  descriptionElement.textContent = flightInfoParts.join(' | ');
}

function groupExpensesByCategory(expenses) {
  const groups = {};
  
  expenses.forEach(expense => {
    const category = getExpenseCategory(expense);
    
    if (!groups[category]) {
      groups[category] = [];
    }
    
    groups[category].push(expense);
  });
  
  return groups;
}

function getExpenseCategory(expense) {
  const type = (expense.exp_type || '').toLowerCase();
  const subtype = (expense.exp_subtype || '').trim();
  
  // Map expense types to categories
  if (type.includes('ground handling')) {
    if (subtype && subtype.toLowerCase().includes('departure')) {
      return 'Ground Handling - Departure';
    }
    if (subtype && subtype.toLowerCase().includes('arrival')) {
      return 'Ground Handling - Arrival';
    }
    return 'Ground Handling';
  }
  
  if (type.includes('fuel')) {
    return 'Fuel';
  }
  
  if (type.includes('disbursement')) {
    return 'Disbursement Fee';
  }
  
  if (type.includes('catering') || type.includes('food')) {
    return 'Catering';
  }
  
  // All other categories go to "Other Charges"
  if (type.includes('navigation') || type.includes('enroute')) {
    return 'Other Charges';
  }
  
  if (type.includes('overflight')) {
    return 'Other Charges';
  }
  
  if (type.includes('landing')) {
    return 'Other Charges';
  }
  
  if (type.includes('flight planning')) {
    return 'Other Charges';
  }
  
  // Default: Other Charges
  return 'Other Charges';
}

function renderExpenseCards(groupedExpenses) {
  const container = document.getElementById('expenses-sections-container');
  container.innerHTML = '';
  
  // Define category order
  const categoryOrder = [
    'Ground Handling',
    'Ground Handling - Departure',
    'Ground Handling - Arrival',
    'Fuel',
    'Disbursement Fee',
    'Catering',
    'Other Charges'
  ];
  
  // Get all categories
  const allCategories = Object.keys(groupedExpenses);
  
  // Sort categories according to defined order
  const sortedCategories = [];
  const usedCategories = new Set();
  
  // First, add categories in defined order
  categoryOrder.forEach(orderedCategory => {
    // Check for exact match first
    if (allCategories.includes(orderedCategory) && !usedCategories.has(orderedCategory)) {
      sortedCategories.push(orderedCategory);
      usedCategories.add(orderedCategory);
    } else {
      // Check for partial match (e.g., "Ground Handling" matches "Ground Handling - Departure")
      const matchingCategory = allCategories.find(cat => 
        !usedCategories.has(cat) && (
          cat.toLowerCase().includes(orderedCategory.toLowerCase()) ||
          orderedCategory.toLowerCase().includes(cat.toLowerCase())
        )
      );
      if (matchingCategory) {
        sortedCategories.push(matchingCategory);
        usedCategories.add(matchingCategory);
      }
    }
  });
  
  // Add remaining categories that weren't in the order list
  allCategories.forEach(category => {
    if (!usedCategories.has(category)) {
      sortedCategories.push(category);
      usedCategories.add(category);
    }
  });
  
  sortedCategories.forEach(category => {
    const expenses = groupedExpenses[category];
    
    // Create category section
    const categorySection = document.createElement('div');
    categorySection.className = 'expense-category-section';
    
    const categoryTitle = document.createElement('h3');
    categoryTitle.className = 'expense-category-title';
    categoryTitle.textContent = category;
    categorySection.appendChild(categoryTitle);
    
    // Create expenses table with total
    const expensesTable = createExpensesTable(expenses, category);
    categorySection.appendChild(expensesTable);
    
    container.appendChild(categorySection);
  });
}

function createExpensesTable(expenses, category) {
  const table = document.createElement('table');
  table.className = 'expenses-table';
  
  // Create header
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Amount</th>
      <th>Place</th>
      <th>Subtype</th>
      <th>Invoice</th>
      <th>Comments</th>
    </tr>
  `;
  table.appendChild(thead);
  
  // Create body
  const tbody = document.createElement('tbody');
  
  let totalUSD = 0;
  const currencyTotals = {};
  
  expenses.forEach(expense => {
    const amount = parseFloat(expense.exp_amount) || 0;
    const currency = expense.exp_currency || 'USD';
    const amountInUSD = convertToUSD(amount, currency);
    totalUSD += amountInUSD;
    
    // Track totals by currency
    if (!currencyTotals[currency]) {
      currencyTotals[currency] = 0;
    }
    currencyTotals[currency] += amount;
    
    const invoiceNumber = expense.invoices?.inv_number || 'N/A';
    const invoiceId = expense.invoices?.id || null;
    const place = expense.exp_place || '';
    const fuelQuantity = expense.exp_fuel_quan || '';
    const fuelProvider = expense.exp_fuel_provider || '';
    const comments = expense.exp_comments || '';
    const subtype = expense.exp_subtype || '';
    
    // Create invoice link if available
    const invoiceLink = invoiceId 
      ? `<a href="/invoices/${invoiceId}" class="expense-invoice-link">${invoiceNumber}</a>`
      : `<span class="expense-invoice-text">${invoiceNumber}</span>`;
    
    // Combine comments with fuel info if available
    let combinedComments = comments;
    const fuelInfoParts = [];
    if (fuelQuantity) {
      fuelInfoParts.push(`Fuel Qty: ${fuelQuantity} L`);
    }
    if (fuelProvider) {
      fuelInfoParts.push(`Fuel Provider: ${fuelProvider}`);
    }
    if (fuelInfoParts.length > 0) {
      const fuelInfo = fuelInfoParts.join(', ');
      combinedComments = comments 
        ? `${comments} | ${fuelInfo}`
        : fuelInfo;
    }
    
    const row = document.createElement('tr');
    row.className = 'expense-row';
    row.innerHTML = `
      <td class="expense-amount-cell">
        <span class="expense-amount-value">$${amountInUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
        <span class="expense-amount-currency">${currency}</span>
      </td>
      <td>${place || '-'}</td>
      <td>${subtype || '-'}</td>
      <td>${invoiceLink}</td>
      <td class="expense-comments-cell">${combinedComments || '-'}</td>
    `;
    tbody.appendChild(row);
  });
  
  // Add total row
  const totalRow = document.createElement('tr');
  totalRow.className = 'expense-total-row';
  
  // Format currency totals
  const currencyTotalsText = Object.keys(currencyTotals)
    .sort()
    .map(currency => {
      const total = currencyTotals[currency];
      return `${total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${currency}`;
    })
    .join(' + ');
  
  totalRow.innerHTML = `
    <td class="expense-amount-cell expense-total-cell">
      <span class="expense-total-label">Total</span>
      <span class="expense-amount-value expense-total-value">$${totalUSD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
      <span class="expense-amount-currency expense-total-currency">${currencyTotalsText}</span>
    </td>
    <td colspan="4" class="expense-total-empty"></td>
  `;
  tbody.appendChild(totalRow);
  
  table.appendChild(tbody);
  return table;
}

function convertToUSD(amount, currency) {
  if (!amount) return 0;
  
  const numAmount = parseFloat(amount);
  
  switch (currency?.toUpperCase()) {
    case 'USD':
      return numAmount;
    case 'AED':
      return numAmount / 3.6735; // AED to USD
    case 'EUR':
      // EUR conversions always go through AED (not directly to USD)
      // EUR → AED: 1 EUR = 4.3119 AED, then AED → USD: 1 AED = 1/3.6735 USD
      return (numAmount * 4.3119) / 3.6735; // EUR → AED → USD
    default:
      return numAmount;
  }
}
</script>

<style>
.loading-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem 1rem;
  text-align: center;
}

.loading-text {
  margin-top: 0.75rem;
  color: #6c757d;
  font-size: 0.9375rem;
}

.content-container {
  margin-top: 0.5rem;
}

.no-data-container {
  padding: 2rem 1rem;
  text-align: center;
}

.expense-category-section {
  margin-bottom: 1rem;
}

.expense-category-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: hsl(210, 6%, 21%);
  margin-bottom: 0.5rem;
  padding-bottom: 0.375rem;
  border-bottom: 1px solid hsl(210, 11%, 85%);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.expenses-table {
  width: 75%;
  border-collapse: collapse;
  background-color: white;
  font-size: 0.75rem;
  border-radius: 0.375rem;
  overflow: hidden;
}

.expenses-table thead {
  background-color: hsl(210, 11%, 96%);
}

.expenses-table th {
  text-align: left;
  padding: 0.25rem 0.5rem;
  font-weight: 600;
  color: hsl(210, 6%, 21%);
  font-size: 0.6875rem;
  text-transform: uppercase;
  letter-spacing: 0.025em;
  border-bottom: 1px solid hsl(210, 11%, 90%);
}

.expenses-table td {
  padding: 0.25rem 0.5rem;
  border-bottom: 1px solid hsl(210, 11%, 95%);
  color: hsl(210, 6%, 21%);
  vertical-align: top;
  font-size: 0.75rem;
}

.expenses-table tbody tr:hover {
  background-color: hsl(210, 11%, 98%);
}

.expense-amount-cell {
  white-space: nowrap;
}

.expense-amount-value {
  font-weight: 600;
  color: hsl(210, 6%, 21%);
  display: block;
  font-size: 0.75rem;
}

.expense-amount-currency {
  font-size: 0.625rem;
  color: hsl(210, 6%, 46%);
  font-weight: normal;
}

.expense-comments-cell {
  max-width: 300px;
  font-style: italic;
  color: hsl(210, 6%, 46%);
  word-wrap: break-word;
  font-size: 0.75rem;
}

.expense-invoice-link {
  color: hsl(210, 76%, 36%);
  text-decoration: underline;
  cursor: pointer;
  transition: color 0.2s ease;
}

.expense-invoice-link:hover {
  color: hsl(210, 76%, 30%);
}

.expense-invoice-text {
  color: hsl(210, 6%, 46%);
}

/* Total row styles */
.expense-total-row {
  background-color: hsl(210, 11%, 97%);
  border-top: 2px solid hsl(210, 11%, 85%);
  font-weight: 600;
}

.expense-total-cell {
  padding-top: 0.5rem !important;
  padding-bottom: 0.5rem !important;
  display: flex !important;
  flex-direction: column !important;
  gap: 0.125rem !important;
}

.expense-total-label {
  font-weight: 600 !important;
  color: hsl(210, 6%, 21%) !important;
  text-transform: uppercase !important;
  font-size: 0.6875rem !important;
  letter-spacing: 0.05em !important;
  margin-bottom: 0.125rem !important;
}

.expense-total-value {
  font-size: 0.875rem !important;
  color: hsl(210, 6%, 21%) !important;
  font-weight: 700 !important;
}

.expense-total-currency {
  font-size: 0.625rem !important;
  color: hsl(210, 6%, 46%) !important;
  font-weight: 500 !important;
}

.expense-total-empty {
  padding-top: 0.5rem !important;
  padding-bottom: 0.5rem !important;
}

.page-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: hsl(210, 6%, 21%);
  margin: 0 0 0.25rem 0;
  padding: 0;
}

.page-header {
  position: sticky;
  top: 4rem;
  z-index: 90;
  background-color: hsl(210, 11%, 98%);
  padding: 0.75rem 0;
  margin-bottom: 0.75rem;
  border-bottom: 1px solid hsl(210, 11%, 90%);
}

.page-description {
  color: hsl(210, 6%, 46%);
  font-size: 0.875rem;
  margin-top: 0.125rem;
}

.page-actions {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}
</style>

